
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../riscv/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>PA - MyDocs for cyberalong</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
    
    
      <link rel="stylesheet" href="https://cdn.tonycrane.cc/jbmono/jetbrainsmono.css">
    
      <link rel="stylesheet" href="https://cdn.tonycrane.cc/utils/katex.min.css">
    
      <link rel="stylesheet" href="../../css/custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#macro-magic" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="MyDocs for cyberalong" class="md-header__button md-logo" aria-label="MyDocs for cyberalong" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.857 13.511c-.48 1.545-2.081 2.995-4.002 3.296.31.48.452 1.074.377 1.733-.208 1.789-1.921 3.23-3.758 3.249-1.243.009-2.928-.528-4.115-2.402-1.064-1.666-1.215-4.313-1.14-5.113-1.299 1.328-2.109 2.618-2.495 3.512-.866 2.025-1.196 4.492-1.177 5.65 0 0-.16.151-.31.18-.48-.085-.895-.264-1.206-.537-.376-.34-.461-.66-.461-.66.574-2.872 1.488-4.66 2.853-6.704 1.836-2.76 4.67-4.464 8.032-5.49 2.43-.744 4.954-.904 6.686.565.933.772.989 1.883.716 2.721M9.544 11.986c-.575.96-2.147 2.505-3.39 3.305-2.59 1.657-4.454 1.77-5.387 1.177a1.5 1.5 0 0 1-.292-.235c-.725-.763-.602-2.119.245-3.23.415-.546.951-.932 1.47-1.111-.406-.189-.679-.584-.735-1.14-.113-1.11.725-2.57 1.883-3.164 1.017-.518 3.211-1.036 4.821 1.366.631.932 1.196 2.26 1.385 3.032M20.184 1.89c-.14-1.384-1.62-1.893-3.248-1.196-.772.33-1.45.885-1.93 1.516.075-.63-.104-1.186-.556-1.516-.895-.65-2.524-.17-3.635 1.036-.386.424-1.648 1.95-1.714 4.19-.028 1.083.452 3.485 2.034 5.142 4.219-1.591 6.488-4.03 7.354-5.038.999-1.168 1.422-2.194 1.601-2.947.132-.594.113-1.017.094-1.187"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MyDocs for cyberalong
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              PA
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="lime"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  Home

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../csapp/" class="md-tabs__link">
          
  
  CSAPP

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  PA

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../tool/" class="md-tabs__link">
          
  
  tool

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../leetcode/" class="md-tabs__link">
          
  
  leetcode

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../life/" class="md-tabs__link">
          
  
  life

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="MyDocs for cyberalong" class="md-nav__button md-logo" aria-label="MyDocs for cyberalong" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.857 13.511c-.48 1.545-2.081 2.995-4.002 3.296.31.48.452 1.074.377 1.733-.208 1.789-1.921 3.23-3.758 3.249-1.243.009-2.928-.528-4.115-2.402-1.064-1.666-1.215-4.313-1.14-5.113-1.299 1.328-2.109 2.618-2.495 3.512-.866 2.025-1.196 4.492-1.177 5.65 0 0-.16.151-.31.18-.48-.085-.895-.264-1.206-.537-.376-.34-.461-.66-.461-.66.574-2.872 1.488-4.66 2.853-6.704 1.836-2.76 4.67-4.464 8.032-5.49 2.43-.744 4.954-.904 6.686.565.933.772.989 1.883.716 2.721M9.544 11.986c-.575.96-2.147 2.505-3.39 3.305-2.59 1.657-4.454 1.77-5.387 1.177a1.5 1.5 0 0 1-.292-.235c-.725-.763-.602-2.119.245-3.23.415-.546.951-.932 1.47-1.111-.406-.189-.679-.584-.735-1.14-.113-1.11.725-2.57 1.883-3.164 1.017-.518 3.211-1.036 4.821 1.366.631.932 1.196 2.26 1.385 3.032M20.184 1.89c-.14-1.384-1.62-1.893-3.248-1.196-.772.33-1.45.885-1.93 1.516.075-.63-.104-1.186-.556-1.516-.895-.65-2.524-.17-3.635 1.036-.386.424-1.648 1.95-1.714 4.19-.028 1.083.452 3.485 2.034 5.142 4.219-1.591 6.488-4.03 7.354-5.038.999-1.168 1.422-2.194 1.601-2.947.132-.594.113-1.017.094-1.187"/></svg>

    </a>
    MyDocs for cyberalong
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Home
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Home
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome to MkDocs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../page1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    buidling
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    CSAPP
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            CSAPP
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csapp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CSAPP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csapp/csapp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bomblab
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../csapp/cs144/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cs144
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    PA
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            PA
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    table of contents
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    PA
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    PA
  </span>
  

      </a>
      
        
  
    
  
  <nav class="md-nav md-nav--secondary " aria-label="On this Page">
    
    
    
    
      <label class="md-nav__title" for="__toc">
        <span class="md-nav__icon md-icon"></span>
        On this Page
      </label>
      <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
        
          <li class="md-nav__item">
  <a href="#macro-magic" class="md-nav__link">
    <span class="md-ellipsis">
      macro magic
    </span>
  </a>
  
    <nav class="md-nav" aria-label="macro magic">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#printf" class="md-nav__link">
    <span class="md-ellipsis">
      printf的含金量
    </span>
  </a>
  
    <nav class="md-nav" aria-label="printf的含金量">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ysyx" class="md-nav__link">
    <span class="md-ellipsis">
      ysyx的例子
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      代码中值得注意的地方
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      就是这么简单
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      解析命令
    </span>
  </a>
  
    <nav class="md-nav" aria-label="解析命令">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#readline" class="md-nav__link">
    <span class="md-ellipsis">
      举例说明readline
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strtok" class="md-nav__link">
    <span class="md-ellipsis">
      关于strtok
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vscode" class="md-nav__link">
    <span class="md-ellipsis">
      vscode不能正确的提交我的仓库
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      单步执行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      关于换行
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#isa_reg_displayvoid" class="md-nav__link">
    <span class="md-ellipsis">
      isa_reg_display(void)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="isa_reg_display(void)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check_reg_idxint-idx" class="md-nav__link">
    <span class="md-ellipsis">
      关于check_reg_idx(int idx)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gprint-idx" class="md-nav__link">
    <span class="md-ellipsis">
      关于gpr(int idx)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      一些哈批例子
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      作用
    </span>
  </a>
  
    <nav class="md-nav" aria-label="作用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      直接启动出现重复打印命令的问题
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      内存扫描
    </span>
  </a>
  
    <nav class="md-nav" aria-label="内存扫描">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pmem_read" class="md-nav__link">
    <span class="md-ellipsis">
      pmem_read
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hostguest" class="md-nav__link">
    <span class="md-ellipsis">
      host和guest
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy-paste" class="md-nav__link">
    <span class="md-ellipsis">
      copy-paste
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      表达式实现
    </span>
  </a>
  
    <nav class="md-nav" aria-label="表达式实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      上次对表达式的实现很蠢
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      如何调试
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      如何编辑
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#static-inline" class="md-nav__link">
    <span class="md-ellipsis">
      static 和 inline
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      为什么不能在头文件中实现函数?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#regex" class="md-nav__link">
    <span class="md-ellipsis">
      关于regex
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strtol" class="md-nav__link">
    <span class="md-ellipsis">
      strtol()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strcmp" class="md-nav__link">
    <span class="md-ellipsis">
      strcmp()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#const-char-str" class="md-nav__link">
    <span class="md-ellipsis">
      为什么要用const char *str
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strncmp" class="md-nav__link">
    <span class="md-ellipsis">
      strncmp()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      表达式扩展
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#watch_point" class="md-nav__link">
    <span class="md-ellipsis">
      watch_point
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pa2" class="md-nav__link">
    <span class="md-ellipsis">
      PA2
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PA2">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gcc" class="md-nav__link">
    <span class="md-ellipsis">
      GCC提供的标签地址
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gcc_1" class="md-nav__link">
    <span class="md-ellipsis">
      告诉GCC总是尝试内联
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      查看复杂工程中某个特定文件的编译过程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="查看复杂工程中某个特定文件的编译过程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make-nb" class="md-nav__link">
    <span class="md-ellipsis">
      make -nB
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dummy" class="md-nav__link">
    <span class="md-ellipsis">
      dummy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dummy_1" class="md-nav__link">
    <span class="md-ellipsis">
      dummy运行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#risc-v" class="md-nav__link">
    <span class="md-ellipsis">
      RISC-V 指令集概述
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      指令格式示例
    </span>
  </a>
  
    <nav class="md-nav" aria-label="指令格式示例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#r-" class="md-nav__link">
    <span class="md-ellipsis">
      R 类型指令（寄存器-寄存器操作）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#i" class="md-nav__link">
    <span class="md-ellipsis">
      I 类型指令（立即数操作）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s" class="md-nav__link">
    <span class="md-ellipsis">
      S 类型指令（存储操作）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      学习资源推荐
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ysyx-workbencham-kernelstestscpu-testsmakefile" class="md-nav__link">
    <span class="md-ellipsis">
      ysyx-workbench/am-kernels/tests/cpu-tests/makefile
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ysyx-workbench/am-kernels/tests/cpu-tests/makefile">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#result" class="md-nav__link">
    <span class="md-ellipsis">
      &gt;.result
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      详细说明
    </span>
  </a>
  
    <nav class="md-nav" aria-label="详细说明">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      示例
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pa21" class="md-nav__link">
    <span class="md-ellipsis">
      PA2.1 指令实现
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PA2.1 指令实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      教训
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gdb" class="md-nav__link">
    <span class="md-ellipsis">
      gdb条件调试
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-nb-vim-" class="md-nav__link">
    <span class="md-ellipsis">
      make -nB | vim -
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#grep-sed" class="md-nav__link">
    <span class="md-ellipsis">
      grep 和 sed 的联合使用
    </span>
  </a>
  
    <nav class="md-nav" aria-label="grep 和 sed 的联合使用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tabnew" class="md-nav__link">
    <span class="md-ellipsis">
      :tabnew命令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      #功能
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xargs" class="md-nav__link">
    <span class="md-ellipsis">
      xargs基本语法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      主要功能
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      主要选项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      使用示例
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      取除
    </span>
  </a>
  
    <nav class="md-nav" aria-label="取除">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 行首匹配符
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 否定字符集
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nemugrep" class="md-nav__link">
    <span class="md-ellipsis">
      nemu中的grep
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sext" class="md-nav__link">
    <span class="md-ellipsis">
      SEXT宏的作用
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pa22" class="md-nav__link">
    <span class="md-ellipsis">
      PA2.2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      链接和加载
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#coreutils-binutilsgnu" class="md-nav__link">
    <span class="md-ellipsis">
      coreutils 和 binutils(GNU工具链)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="coreutils 和 binutils(GNU工具链)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#coreutils" class="md-nav__link">
    <span class="md-ellipsis">
      coreutils
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    
  </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../riscv/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    riscv
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    tool
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            tool
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tool/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    介绍一些使用的工具
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tool/git/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    git
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tool/chatgpt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    chatgpt
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tool/gdb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    gdb
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tool/rust/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rust
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tool/shell_gpt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    shell_gpt
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    leetcode
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            leetcode
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../leetcode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    leetcode
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../leetcode/base/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    基础算法
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    life
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            life
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../life/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    我的生活
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../life/2024-6-15/2024-6-15/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    南京之旅
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../life/2024-7-17/2024-7-17/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    做饭技巧
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <h1>PA</h1>

<p>整个实验逐步引导完成一个计算机系统的构建,包括底层的 NEMU 模拟器,运行时环境 AbstractMachine（AM）,在其上的简易操作系统 NanOS-lite,以及操作系统上的应用程序库 Navy-apps.</p>
<p>一共分为 5 个部分,PA0 配置环境,PA1 完善 NEMU 的调试器功能,PA2 模拟 NEMU 指令运行以及补充 AM,PA3 完善 NEMU 的中断 / 异常处理、实现操作系统的系统调用以及简易文件系统功能,PA4 在操作系统中实现多道程序的运行、虚拟内存管理以及外部中断处理.</p>
<p>细分每个实验的内容以及涉及到的源码部分,我整理了如下一个表格供参考：</p>
<p>PS：其中 AM 由五个部分组成,TRM（图灵机模拟）简单而且已经实现好了,IOE 为输入输出扩展,CTE 为上下文管理扩展,VME 为虚拟内存管理扩展,还有一个 MPE（多处理器扩展）在 PA 中不使用.klib 为简单的运行时库,提供给 AM 和操作系统使用.</p>
<p>总而言之有了计算机系统课以及 RISCV 手册阅读的基础,大部分实验还是比较轻松的,没有什么难以理解的地方.较为痛苦的就是 debug 时一些奇怪的问题以及最后 PA4 中之前没有接触过的虚存管理的内容了.后面记录一些还能回忆起来的问题（其实是做的过程中懒得记录）.</p>
<h2 id="macro-magic">macro magic<a class="headerlink" href="#macro-magic" title="Anchor link to this section for reference">&para;</a></h2>
<p>炫酷的跨平台能力跨架构能力却是靠着看上去笨拙其实炫酷的宏技术实现的,所以我们不妨叫他魔法宏.这里有一些宏技术的例子,可以帮助你理解宏的强大之处.
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="cp">#define ARRLEN(arr) (int)(sizeof(arr) / sizeof(arr[0]))</span>
</code></pre></div></p>
<p>See <a href="https://stackoverflow.com/questions/26099745/test-if-preprocessor-symbol-is-defined-inside-macro">stackoverflow的帖子关于macro</a></p>
<p>Compare the stringified macro (name) to the stringified (expanded) value of the macro:
将字符串化宏（名称）与宏的字符串化（扩展）值进行比较：
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstring&gt;</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="cp">#define TRACE_STRINGIFY(item) &quot;&quot; #item</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="cp">#define TRACE(macro, message)                          \</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="cp">    do {                                               \</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="cp">        if (strcmp(&quot;&quot; #macro, TRACE_STRINGIFY(macro))) \</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="cp">            std::cout &lt;&lt; message &lt;&lt; &quot;\n&quot;;              \</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="cp">    } while (0)</span>
</code></pre></div>
这段代码是C++中的宏定义,用于在编译时期生成代码.让我们逐行解析：</p>
<ol>
<li>
<p><code>#include &lt;iostream&gt;</code> 和 <code>#include &lt;cstring&gt;</code> 是包含标准库的头文件,分别提供了输入/输出功能和字符串处理功能.</p>
</li>
<li>
<p><code>#define TRACE_STRINGIFY(item) "" #item</code> 是一个宏定义,用于将输入的参数转换为字符串.<code>#</code>操作符在宏定义中被称为"字符串化"操作符,它会将后面的参数转换为字符串.</p>
</li>
</ol>
<p>那么为什么#item前面要加引号呢“”？</p>
<p>在C语言的宏定义中,<code>#</code>操作符被称为"字符串化"操作符,它会将后面的宏参数转换为字符串.但是,如果直接使用<code>#item</code>,并且<code>item</code>是一个宏,那么预处理器会先将<code>item</code>转换为它所代表的值,然后再将结果转换为字符串.</p>
<p>例如,假设我们有以下的宏定义：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="cp">#define VALUE 10</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="cp">#define TO_STRING(item) #item</span>
</code></pre></div>
<p>如果我们使用<code>TO_STRING(VALUE)</code>,预处理器会先将<code>VALUE</code>替换为<code>10</code>,然后将<code>10</code>转换为字符串,得到<code>"10"</code>.</p>
<p>但是,如果我们想得到字符串<code>"VALUE"</code>而不是<code>"10"</code>,我们就需要阻止预处理器对<code>VALUE</code>的宏扩展.这就是为什么我们在<code>#item</code>前面加上<code>""</code>的原因.<code>"" #item</code>会先将<code>item</code>转换为字符串,然后与前面的空字符串连接,得到的结果就是我们想要的<code>"VALUE"</code>.</p>
<p>所以,<code>#define TRACE_STRINGIFY(item) "" #item</code>这个宏定义的作用是将输入的参数转换为字符串,同时阻止预处理器对参数进行宏扩展.</p>
<ol>
<li>
<p><code>#define TRACE(macro, message)</code> 定义了一个名为<code>TRACE</code>的宏,它接受两个参数：<code>macro</code>和<code>message</code>.</p>
</li>
<li>
<p><code>do { ... } while (0)</code> 是一个常见的宏技巧,用于确保宏的使用方式和函数调用一样,即使在需要使用分号结束的地方也不会出错.<code>do { ... } while (0)</code> 是一个常见的宏定义技巧,主要是为了解决宏扩展中可能出现的问题.</p>
</li>
</ol>
<p>在C/C++中,宏是在预处理阶段进行文本替换的,它并不像函数那样有自己的作用域.如果一个宏定义包含多条语句,而在使用这个宏的地方没有正确地用括号包围它,就可能导致预期之外的行为.</p>
<p>例如,考虑以下宏定义和使用：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="cp">#define MACRO(x) foo(x); bar(x)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="n">MACRO</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="k">else</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="n">baz</span><span class="p">();</span>
</code></pre></div>
<p>这段代码会被预处理器扩展为：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="n">foo</span><span class="p">(</span><span class="n">y</span><span class="p">);</span><span class="w"> </span><span class="n">bar</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="k">else</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span><span class="n">baz</span><span class="p">();</span>
</code></pre></div>
<p>这并不是我们想要的结果,因为<code>bar(y);</code>总是会被执行,而不管<code>condition</code>的值是什么.</p>
<p>如果我们使用<code>do { ... } while (0)</code>,就可以避免这个问题：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="cp">#define MACRO(x) do { foo(x); bar(x); } while (0)</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="n">MACRO</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="k">else</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="n">baz</span><span class="p">();</span>
</code></pre></div>
<p>这段代码会被预处理器扩展为：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="n">y</span><span class="p">);</span><span class="w"> </span><span class="n">bar</span><span class="p">(</span><span class="n">y</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="k">else</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span><span class="n">baz</span><span class="p">();</span>
</code></pre></div>
<p>这样就可以得到我们期望的行为：只有当<code>condition</code>为真时,<code>foo(y)</code>和<code>bar(y)</code>才会被执行.</p>
<ol>
<li>
<p><code>if (strcmp("" #macro, TRACE_STRINGIFY(macro)))</code> 这行代码比较复杂.首先,<code>"" #macro</code>将<code>macro</code>参数字符串化.然后,<code>TRACE_STRINGIFY(macro)</code>也将<code>macro</code>参数字符串化.<code>strcmp</code>函数比较这两个字符串,如果它们相等,返回0,否则返回非0值.因此,这个<code>if</code>语句的条件是"如果<code>macro</code>参数字符串化后的结果和自身不相等".</p>
</li>
<li>
<p><code>std::cout &lt;&lt; message &lt;&lt; "\n";</code> 如果上述<code>if</code>条件为真,那么就输出<code>message</code>参数,并在其后添加一个换行符.</p>
</li>
</ol>
<p>这个宏的目的是检查<code>macro</code>参数是否已经被定义为一个宏.如果<code>macro</code>已经被定义为一个宏,那么<code>TRACE_STRINGIFY(macro)</code>将返回该宏的值,而不是<code>macro</code>本身,因此<code>strcmp</code>的结果将不为0,从而触发消息的输出.
The "" # macro expands to the macro name as a string, whereas TRACE_STRINGIFY(macro) first expands the macro, then stringifies the result. If the two differ, macro has to be a preprocessor macro.
"" # macro 将宏名扩展为字符串,而 TRACE_STRINGIFY(macro) 首先扩展宏,然后将结果字符串化.如果两者不同,则 macro 必须是预处理器宏.</p>
<p>This approach does fail for macros that are defined to themselves, i.e. #define FOO FOO. Such macros are not detected as preprocessor macros.
这种方法对于定义为自身的宏（即 #define FOO FOO ）确实失败.这样的宏不会被检测为预处理器宏.</p>
<p>Most compilers should be able to completely optimize away the comparison of two string literals. GNU GCC (g++) 4.8.2 definitely does even with -O0 (as does gcc for C -- the same approach obviously works in C, too).
大多数编译器应该能够完全优化两个字符串的比较.GNU GCC（g++）4.8.2甚至对 -O0 也是如此（gcc对C也是如此--同样的方法显然也适用于C）.</p>
<p>This approach does work for function-like macros, but only if you retain the parentheses (and proper number of commas, if the macro takes multiple parameters) and it is not defined to itself (e.g. #define BAR(x) BAR(x)).
这种方法确实适用于类似函数的宏,但前提是您保留括号（以及适当数量的逗号,如果宏接受多个参数）并且它没有定义为自身（例如 #define BAR(x) BAR(x) ）.</p>
<p>For example: 举例来说：</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="cp">#define TEST1 TEST1</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="cp">#define TEST3</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="cp">#define TEST4 0</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="cp">#define TEST5 1</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="cp">#define TEST6 &quot;string&quot;</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="cp">#define TEST7 &quot;&quot;</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="cp">#define TEST8 NULL</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="cp">#define TEST9 TEST3</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="cp">#define TEST10 TEST2</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="cp">#define TEST11(x)</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="cp">#define TEST13(x,y,z) (x, y, z)</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="p">{</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TEST1 is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TEST2 is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TEST3 is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST4</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TEST4 is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST5</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TEST5 is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST6</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TEST6 is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST7</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TEST7 is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST8</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TEST8 is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST9</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TEST9 is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST10</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TEST10 is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST11</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TEST11 is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST12</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TEST12 is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST13</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TEST13 is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST14</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TEST14 is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST1</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;TEST1() is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST2</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;TEST2() is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST3</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;TEST3() is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST4</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;TEST4() is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST5</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;TEST5() is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST6</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;TEST6() is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST7</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;TEST7() is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST8</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;TEST8() is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST9</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;TEST9() is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST10</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;TEST10() is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST11</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;TEST11() is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST12</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;TEST12() is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST13</span><span class="p">(,,),</span><span class="w"> </span><span class="s">&quot;TEST13(,,) is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a><span class="w">    </span><span class="n">TRACE</span><span class="p">(</span><span class="n">TEST14</span><span class="p">(,,),</span><span class="w"> </span><span class="s">&quot;TEST14(,,) is defined&quot;</span><span class="p">);</span>
<a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a>
<a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a><span class="p">}</span>
<a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a><span class="n">which</span><span class="w"> </span><span class="n">outputs</span><span class="w"> </span><span class="n">其输出</span>
<a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a>
<a id="__codelineno-7-52" name="__codelineno-7-52" href="#__codelineno-7-52"></a><span class="n">TEST3</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span>
<a id="__codelineno-7-53" name="__codelineno-7-53" href="#__codelineno-7-53"></a><span class="n">TEST4</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span>
<a id="__codelineno-7-54" name="__codelineno-7-54" href="#__codelineno-7-54"></a><span class="n">TEST5</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span>
<a id="__codelineno-7-55" name="__codelineno-7-55" href="#__codelineno-7-55"></a><span class="n">TEST6</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span>
<a id="__codelineno-7-56" name="__codelineno-7-56" href="#__codelineno-7-56"></a><span class="n">TEST7</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span>
<a id="__codelineno-7-57" name="__codelineno-7-57" href="#__codelineno-7-57"></a><span class="n">TEST8</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span>
<a id="__codelineno-7-58" name="__codelineno-7-58" href="#__codelineno-7-58"></a><span class="n">TEST9</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span>
<a id="__codelineno-7-59" name="__codelineno-7-59" href="#__codelineno-7-59"></a><span class="n">TEST10</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span>
<a id="__codelineno-7-60" name="__codelineno-7-60" href="#__codelineno-7-60"></a><span class="n">TEST3</span><span class="p">()</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span>
<a id="__codelineno-7-61" name="__codelineno-7-61" href="#__codelineno-7-61"></a><span class="n">TEST4</span><span class="p">()</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span>
<a id="__codelineno-7-62" name="__codelineno-7-62" href="#__codelineno-7-62"></a><span class="n">TEST5</span><span class="p">()</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span>
<a id="__codelineno-7-63" name="__codelineno-7-63" href="#__codelineno-7-63"></a><span class="n">TEST6</span><span class="p">()</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span>
<a id="__codelineno-7-64" name="__codelineno-7-64" href="#__codelineno-7-64"></a><span class="n">TEST7</span><span class="p">()</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span>
<a id="__codelineno-7-65" name="__codelineno-7-65" href="#__codelineno-7-65"></a><span class="n">TEST8</span><span class="p">()</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span>
<a id="__codelineno-7-66" name="__codelineno-7-66" href="#__codelineno-7-66"></a><span class="n">TEST9</span><span class="p">()</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span>
<a id="__codelineno-7-67" name="__codelineno-7-67" href="#__codelineno-7-67"></a><span class="n">TEST10</span><span class="p">()</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span>
<a id="__codelineno-7-68" name="__codelineno-7-68" href="#__codelineno-7-68"></a><span class="n">TEST11</span><span class="p">()</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span>
<a id="__codelineno-7-69" name="__codelineno-7-69" href="#__codelineno-7-69"></a><span class="n">TEST13</span><span class="p">(,,)</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span>
</code></pre></div>
In other words, the TEST1 symbol is not recognized as defined (because it is defined to itself), nor are TEST11 or TEST13 without parentheses. These are the limitations of this approach.
换句话说, TEST1 符号不会被识别为已定义（因为它是对自身定义的）,没有括号的 TEST11 或 TEST13 也不会被识别为已定义.这些是这种方法的局限性.</p>
<p>Using the parenthesized form works for all parameterless macros (except TEST1, ie. those defined to themselves), and all single-parameter macros. If a macro expects multiple parameters, you need to use the correct number of commas, as otherwise (say, if you tried TRACE(TEST13(), "...")) you get a compile-time error: "macro TEST13 requires 3 arguments, only 1 given" or similar.
使用括号形式适用于所有无参数宏（除了 TEST1 ,即.它们是自己定义的）,以及所有单参数宏.如果一个宏需要多个参数,你需要使用正确数量的逗号,否则（比如说,如果你尝试 TRACE(TEST13(), "...") ）你会得到一个编译时错误：“宏 TEST13 需要3个参数,只有1个给定”或类似的.</p>
<h3 id="printf">printf的含金量<a class="headerlink" href="#printf" title="Anchor link to this section for reference">&para;</a></h3>
<p><code>printf</code>函数是C语言中用于格式化输出的函数,它有很多特殊的用法.以下是一些例子：</p>
<h4 id="ysyx">ysyx的例子<a class="headerlink" href="#ysyx" title="Anchor link to this section for reference">&para;</a></h4>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">isa_reg_display</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">reg_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ARRLEN</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">reg_num</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%-4s: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">cpu</span><span class="p">.</span><span class="n">gpr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="p">}</span>
</code></pre></div>
这段代码是用于在C语言中打印CPU寄存器的值.它使用了<code>printf</code>函数,这是一个标准的C库函数,用于格式化输出到标准输出设备,通常是屏幕.</p>
<p><code>printf</code>函数的第一个参数是一个格式字符串,它定义了输出的格式.在这个例子中,格式字符串是<code>"%-4s: 0x%08x\n"</code>.</p>
<p><code>%-4s</code>表示一个字符串,<code>-</code>表示左对齐,<code>4</code>表示这个字符串的最小宽度是4.如果<code>regs[i]</code>的长度小于4,那么输出的字符串将被空格填充到4个字符.</p>
<p><code>: 0x%08x</code>表示一个以十六进制形式输出的整数.<code>0x</code>是一个前缀,表示这个数是十六进制的.<code>%08x</code>表示这个整数至少有8位,如果不足8位,那么输出的字符串将被0填充到8位.</p>
<p><code>\n</code>是一个换行符,表示在输出这一行后换行.</p>
<p><code>printf</code>函数的后续参数是要插入到格式字符串中的值.在这个例子中,[<code>regs[i]</code>]是要插入到<code>%-4s</code>的位置的字符串,<code>cpu.gpr[i]</code>是要插入到<code>%08x</code>的位置的整数.</p>
<p>总的来说,这段代码将会输出类似于<code>eax : 0x0000001f</code>这样的字符串,其中<code>eax</code>是寄存器的名字,<code>0x0000001f</code>是寄存器的值.</p>
<ol>
<li><strong>字段宽度和精度</strong>：你可以在格式字符串中指定字段的宽度和精度.例如,<code>%5d</code>表示一个至少有5个字符宽的整数,<code>%.2f</code>表示一个小数点后有2位的浮点数.</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%5d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">123</span><span class="p">);</span><span class="w">  </span><span class="c1">// 输出：&quot;  123&quot;</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%.2f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">3.14159</span><span class="p">);</span><span class="w">  </span><span class="c1">// 输出：&quot;3.14&quot;</span>
</code></pre></div>
<ol>
<li><strong>左对齐和右对齐</strong>：默认情况下,<code>printf</code>函数会右对齐输出.你可以使用<code>-</code>标志来改变这个行为.例如,<code>%-5d</code>表示一个左对齐的至少有5个字符宽的整数.</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%-5d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">123</span><span class="p">);</span><span class="w">  </span><span class="c1">// 输出：&quot;123  &quot;</span>
</code></pre></div>
<ol>
<li><strong>填充字符</strong>：默认情况下,<code>printf</code>函数会使用空格来填充字段.你可以使用<code>0</code>标志来改变这个行为.例如,<code>%05d</code>表示一个用0填充的至少有5个字符宽的整数.</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%05d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">123</span><span class="p">);</span><span class="w">  </span><span class="c1">// 输出：&quot;00123&quot;</span>
</code></pre></div>
<ol>
<li><strong>十六进制和八进制</strong>：你可以使用<code>%x</code>和<code>%o</code>来输出十六进制和八进制的整数.你还可以使用<code>#</code>标志来添加前缀.</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">);</span><span class="w">  </span><span class="c1">// 输出：&quot;ff&quot;</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">);</span><span class="w">  </span><span class="c1">// 输出：&quot;0xff&quot;</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%o</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">);</span><span class="w">  </span><span class="c1">// 输出：&quot;377&quot;</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%#o</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">);</span><span class="w">  </span><span class="c1">// 输出：&quot;0377&quot;</span>
</code></pre></div>
<ol>
<li><strong>指针</strong>：你可以使用<code>%p</code>来输出指针的值.</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">);</span><span class="w">  </span><span class="c1">// 输出类似于：&quot;0x7fffc72c4b3c&quot;</span>
</code></pre></div>
<ol>
<li><strong>字符串</strong>：你可以使用<code>%s</code>来输出字符串.</li>
</ol>
<p>```chttps://alongcyber.github.io/notetest/PA/PA/ 输出："Hello, world!"
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>以上只是`printf`函数的一部分特殊用法.`printf`函数还有很多其他的特性和选项,你可以查阅C语言的文档来了解更多.
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>### 优雅的退出
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>```c
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>int is_exit_status_bad() {
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>  int good = (nemu_state.state == NEMU_END &amp;&amp; nemu_state.halt_ret == 0) ||
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>    (nemu_state.state == NEMU_QUIT);
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>  return !good;
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>}
</code></pre></div>
直接在cmd_q中修改成退出前把nemu_state.state改成NEMU_QUIT</p>
<h4 id="_1">代码中值得注意的地方<a class="headerlink" href="#_1" title="Anchor link to this section for reference">&para;</a></h4>
<p>最后我们聊聊代码中一些值得注意的地方.</p>
<ul>
<li>三个对调试有用的宏(在nemu/include/debug.h中定义)<ul>
<li><code>Log()</code>是<code>printf()</code>的升级版, 专门用来输出调试信息, 同时还会输出使用<code>Log()</code>所在的源文件, 行号和函数. 当输出的调试信息过多的时候, 可以很方便地定位到代码中的相关位置</li>
<li><code>Assert()</code>是<code>assert()</code>的升级版, 当测试条件为假时, 在<code>assertion fail</code>之前可以输出一些信息</li>
<li><code>panic()</code>用于输出信息并结束程序, 相当于无条件的<code>assertion fail</code></li>
</ul>
</li>
</ul>
<p>代码中已经给出了使用这三个宏的例子, 如果你不知道如何使用它们, RTFSC.</p>
<ul>
<li>内存通过在nemu/src/memory/paddr.c中定义的大数组pmem来模拟. 在客户程序运行的过程中, 总是使用vaddr_read()和vaddr_write() (在nemu/src/memory/vaddr.c中定义)来访问模拟的内存. vaddr, paddr分别代表虚拟地址和物理地址. 这些概念在将来才会用到, 目前不必深究, 但从现在开始保持接口的一致性可以在将来避免一些不必要的麻烦.</li>
</ul>
<h3 id="_2">就是这么简单<a class="headerlink" href="#_2" title="Anchor link to this section for reference">&para;</a></h3>
<p>事实上, TRM(Technical Reference Model)的实现已经都蕴含在上述的介绍中了.</p>
<ul>
<li>存储器是个在<code>nemu/src/memory/paddr.c</code>中定义的大数组</li>
<li>PC和通用寄存器都在<code>nemu/src/isa/$ISA/include/isa-def.h</code>中的结构体中定义</li>
<li>加法器在... 嗯, 这部分框架代码有点复杂, 不过它并不影响我们对TRM的理解, 我们还是在PA2里面再介绍它吧</li>
<li>TRM的工作方式通过<code>cpu_exec()</code>和<code>exec_once()</code>体现
在NEMU中, 我们只需要一些很基础的C语言知识就可以理解最简单的计算机的工作方式, 真应该感谢先驱啊.</li>
</ul>
<h3 id="_3">解析命令<a class="headerlink" href="#_3" title="Anchor link to this section for reference">&para;</a></h3>
<p>为了让简易调试器易于使用, NEMU通过readline库与用户交互, 使用readline()函数从键盘上读入命令. 与gets()相比, readline()提供了"行编辑"的功能, 最常用的功能就是通过上, 下方向键翻阅历史记录. 事实上, shell程序就是通过readline()读入命令的. 关于readline()的功能和返回值等信息, 请查阅
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>man<span class="w"> </span>strtok
</code></pre></div>
另外, cmd_help()函数中也给出了使用strtok()的例子. 事实上, 字符串处理函数有很多, 键入以下内容:</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>man<span class="w"> </span><span class="m">3</span><span class="w"> </span>str&lt;TAB&gt;&lt;TAB&gt;
</code></pre></div>
其中<TAB>代表键盘上的TAB键. 你会看到很多以str开头的函数, 其中有你应该很熟悉的strlen(), strcpy()等函数. 你最好都先看看这些字符串处理函数的manual page, 了解一下它们的功能, 因为你很可能会用到其中的某些函数来帮助你解析命令. 当然你也可以编写你自己的字符串处理函数来解析命令.</p>
<p>另外一个值得推荐的字符串处理函数是sscanf(), 它的功能和scanf()很类似, 不同的是sscanf()可以从字符串中读入格式化的内容, 使用它有时候可以很方便地实现字符串的解析. 如果你从来没有使用过它们, RTFM, 或者STFW.</p>
<p>GNU的<code>readline</code>库提供了一种方便的方式来处理用户的输入,包括行编辑,历史记录和自动补全.以下是一些基本的使用方法：</p>
<ol>
<li>
<p><strong>初始化readline</strong>：在使用readline之前,你需要先初始化它.这通常在程序开始时完成：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;readline/readline.h&gt;</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;readline/history.h&gt;</span>
</code></pre></div>
</li>
<li>
<p><strong>读取输入</strong>：你可以使用<code>readline</code>函数来读取用户的输入.这个函数接受一个提示字符串作为参数,并返回用户输入的字符串.例如：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readline</span><span class="p">(</span><span class="s">&quot;Enter your command: &quot;</span><span class="p">);</span>
</code></pre></div>
<p>用户可以使用readline的行编辑功能来修改他们的输入.当他们按下Enter键时,<code>readline</code>函数将返回他们输入的字符串.</p>
</li>
<li>
<p><strong>处理历史记录</strong>：你可以使用<code>add_history</code>函数来添加一个命令到历史记录中：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">add_history</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
</code></pre></div>
<p>用户可以使用上下箭头键来浏览历史记录.</p>
</li>
<li>
<p><strong>自动补全</strong>：你可以使用<code>rl_completion_entry_function</code>和<code>rl_attempted_completion_function</code>来定制自动补全的行为.例如,你可以设置一个函数来提供可能的补全,或者改变补全的规则.</p>
</li>
<li>
<p><strong>清理</strong>：当你完成了readline的使用,你应该释放它返回的字符串：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="n">free</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
</code></pre></div>
</li>
</ol>
<p>以上就是GNU readline的基本用法.请注意,readline库的功能非常强大,这里只是介绍了一些基本的用法.如果你想了解更多,你可以查阅readline的官方文档.</p>
<h4 id="readline">举例说明readline<a class="headerlink" href="#readline" title="Anchor link to this section for reference">&para;</a></h4>
<p>以下是一个使用GNU readline库的简单C程序示例.这个程序会提示用户输入命令,然后将命令添加到历史记录中,并打印出来.用户可以使用readline的行编辑和历史功能.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;readline/readline.h&gt;</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;readline/history.h&gt;</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">;</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="w">        </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readline</span><span class="p">(</span><span class="s">&quot;Enter command: &quot;</span><span class="p">);</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="w">            </span><span class="c1">// EOF, exit loop</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;You entered: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">);</span>
<a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a><span class="w">            </span><span class="n">add_history</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>
<a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a><span class="w">        </span><span class="n">free</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
<a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a>
<a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a><span class="p">}</span>
</code></pre></div>
<p>在这个程序中,我们使用<code>readline</code>函数读取用户的输入.我们传递一个提示字符串"Enter command: "给<code>readline</code>函数,然后它会返回用户输入的字符串.(而且readline会打印提示字符串)</p>
<p>我们检查返回的字符串是否为NULL,如果是NULL,那么我们就退出循环.否则,我们就打印出用户输入的字符串,并使用<code>add_history</code>函数将它添加到历史记录中.</p>
<p>最后,我们使用<code>free</code>函数释放<code>readline</code>函数返回的字符串.</p>
<p>要编译这个程序,你需要链接readline库.在gcc中,你可以使用<code>-lreadline</code>选项来做到这一点：</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>gcc<span class="w"> </span>-o<span class="w"> </span>my_program<span class="w"> </span>my_program.c<span class="w"> </span>-lreadline
</code></pre></div>
nemu中的example</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="cm">/* We use the `readline&#39; library to provide more flexibility to read from stdin. */</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="nf">rl_gets</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">line_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">line_read</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">line_read</span><span class="p">);</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="w">    </span><span class="n">line_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="w">  </span><span class="n">line_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readline</span><span class="p">(</span><span class="s">&quot;(nemu) &quot;</span><span class="p">);</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">line_read</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">*</span><span class="n">line_read</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="w">    </span><span class="n">add_history</span><span class="p">(</span><span class="n">line_read</span><span class="p">);</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">line_read</span><span class="p">;</span>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="p">}</span>
</code></pre></div>
<h4 id="strtok">关于strtok<a class="headerlink" href="#strtok" title="Anchor link to this section for reference">&para;</a></h4>
<p><code>strtok</code>是一个C语言库函数,用于在字符串中查找并分割出一系列的标记（tokens）.它的原型如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">strtok</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">delim</span><span class="p">);</span>
</code></pre></div>
<p>这个函数接受两个参数：一个是要分割的字符串<code>str</code>,另一个是包含分隔符的字符串<code>delim</code>.函数会在<code>str</code>中查找<code>delim</code>中的任何字符,并将其作为标记的结束.然后,它会在<code>str</code>中插入一个null字符来结束这个标记,并返回一个指向这个标记的指针.</p>
<p>在连续的调用中,你可以传递NULL作为第一个参数,<code>strtok</code>会继续在上次的字符串上进行操作,查找下一个标记.</p>
<p>例如,以下的代码会分割一个由空格分隔的字符串：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="kt">char</span><span class="w"> </span><span class="n">str</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Hello, how are you?&quot;</span><span class="p">;</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtok</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">);</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">token</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">);</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">    </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">);</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="p">}</span>
</code></pre></div>
<p>这段代码会输出：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>Hello,
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>how
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>are
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>you?
</code></pre></div>
<p>请注意,<code>strtok</code>函数会修改它的输入字符串,所以如果你需要保留原始字符串,你应该在调用<code>strtok</code>之前创建一个副本.另外,<code>strtok</code>函数不是线程安全的,如果你在多线程环境中需要分割字符串,你应该使用<code>strtok_r</code>函数．</p>
<h4 id="vscode">vscode不能正确的提交我的仓库<a class="headerlink" href="#vscode" title="Anchor link to this section for reference">&para;</a></h4>
<p>这让我很困惑,出现该报错Git: gpg failed to sign the data,但是我仅仅配置过ssh-key,而且我在vscode输入法会把,半角逗号自动改为全角真的恼火.明白了现在是因为vscode有个哈批设置叫做提交也得commit signed真的是哈批下的一比,<a href="https://withblue.ink/2020/05/17/how-and-why-to-sign-git-commits.html">how-and-why-to-sign-git-commits</a>,wcnmd太抽象了,这byd也能倒逼的,用vscode功能倒逼用户用这个commit signed,byd每次提交都得验证密钥.有点像byd每一下都得验证自愿了</p>
<h4 id="_4">单步执行<a class="headerlink" href="#_4" title="Anchor link to this section for reference">&para;</a></h4>
<p>从<code>cmd_c</code>就可以看出来<code>cpu_exec()</code>的含金量</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">cmd_s</label><label for="__tabbed_1_2">cpu_exec()</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">cmd_s</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="n">args</span><span class="p">){</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">);</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="k">if</span><span class="p">(</span><span class="n">arg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">){</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">    </span><span class="n">cpu_exec</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="p">}</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="k">else</span><span class="p">{</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Invalid argument</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="w">    </span><span class="n">cpu_exec</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="p">}</span>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="p">}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="cm">/* Simulate how the CPU works. */</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">cpu_exec</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="n">g_print_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_INST_TO_PRINT</span><span class="p">);</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">nemu_state</span><span class="p">.</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">NEMU_END</span><span class="p">:</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="no">NEMU_ABORT</span><span class="p">:</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Program execution has ended. To restart the program, exit NEMU and run again.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">nemu_state</span><span class="p">.</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NEMU_RUNNING</span><span class="p">;</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="p">}</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="kt">uint64_t</span><span class="w"> </span><span class="n">timer_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_time</span><span class="p">();</span>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="n">execute</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="kt">uint64_t</span><span class="w"> </span><span class="n">timer_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_time</span><span class="p">();</span>
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="n">g_timer</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">timer_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">timer_start</span><span class="p">;</span>
<a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a>
<a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">nemu_state</span><span class="p">.</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">NEMU_RUNNING</span><span class="p">:</span><span class="w"> </span><span class="n">nemu_state</span><span class="p">.</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NEMU_STOP</span><span class="p">;</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a>
<a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">NEMU_END</span><span class="p">:</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="no">NEMU_ABORT</span><span class="p">:</span>
<a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a><span class="w">    </span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;nemu: %s at pc = &quot;</span><span class="w"> </span><span class="n">FMT_WORD</span><span class="p">,</span>
<a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a><span class="w">        </span><span class="p">(</span><span class="n">nemu_state</span><span class="p">.</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NEMU_ABORT</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ANSI_FMT</span><span class="p">(</span><span class="s">&quot;ABORT&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ANSI_FG_RED</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a><span class="w">        </span><span class="p">(</span><span class="n">nemu_state</span><span class="p">.</span><span class="n">halt_ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ANSI_FMT</span><span class="p">(</span><span class="s">&quot;HIT GOOD TRAP&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ANSI_FG_GREEN</span><span class="p">)</span><span class="w"> </span><span class="o">:</span>
<a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a><span class="w">            </span><span class="n">ANSI_FMT</span><span class="p">(</span><span class="s">&quot;HIT BAD TRAP&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ANSI_FG_RED</span><span class="p">))),</span>
<a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a><span class="w">        </span><span class="n">nemu_state</span><span class="p">.</span><span class="n">halt_pc</span><span class="p">);</span>
<a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a><span class="w">    </span><span class="c1">// fall through</span>
<a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">NEMU_QUIT</span><span class="p">:</span><span class="w"> </span><span class="n">statistic</span><span class="p">();</span>
<a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a><span class="p">}</span>
<a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a><span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<h4 id="_5">关于换行<a class="headerlink" href="#_5" title="Anchor link to this section for reference">&para;</a></h4>
<p>在C语言中,你可以使用反斜杠（<code>\</code>）在源代码中将一行字符串字面量分成两行.这被称为行连接.例如：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="n">printf</span><span class="p">(</span><span class="s">&quot;这是一行非常非常非常非常非常非常非常非常非常非常\</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="s">非常非常非常非常非常非常非常非常非常非常长的文本.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</code></pre></div>
<p>在这个例子中,反斜杠告诉C编译器这行代码还没有结束,下一行是这行的继续.这样,你可以在源代码中将一行非常长的字符串字面量分成多行,而在程序运行时,这些行会被连接成一个单一的字符串.</p>
<p>请注意,<strong>反斜杠后面不能有任何字符,包括空格或者注释.反斜杠后面的第一个字符必须是换行符.</strong></p>
<h3 id="isa_reg_displayvoid">isa_reg_display(void)<a class="headerlink" href="#isa_reg_displayvoid" title="Anchor link to this section for reference">&para;</a></h3>
<p>这段代码是一个C语言头文件,定义了一些与RISC-V处理器的寄存器相关的函数和宏.RISC-V是一个开源的指令集架构,被广泛用于教学和研究.</p>
<p>然后,代码定义了一个预处理器宏<code>__RISCV_REG_H__</code>,用于防止这个头文件被多次包含.如果这个宏已经被定义,那么预处理器会跳过这个文件的剩余部分.否则,它会定义这个宏,并继续处理文件.</p>
<p>接下来,代码包含了一个名为<code>common.h</code>的头文件.这个头文件可能包含了一些常用的类型定义和函数声明.</p>
<p>然后,代码定义了一个名为<code>check_reg_idx</code>的内联函数,用于检查寄存器索引是否有效.这个函数接受一个整数参数<code>idx</code>,并检查它是否在0和<code>MUXDEF(CONFIG_RVE, 16, 32)</code>之间.如果<code>CONFIG_RT_CHECK</code>被定义,那么这个检查会被执行,否则它会被忽略.函数返回传入的索引.</p>
<p>接着,代码定义了一个名为<code>gpr</code>的宏,用于访问CPU的通用寄存器.这个宏接受一个索引参数,通过<code>check_reg_idx</code>函数检查这个索引是否有效,然后返回对应的寄存器.</p>
<p>最后,代码定义了一个名为<code>reg_name</code>的内联函数,用于获取寄存器的名称.这个函数接受一个整数参数<code>idx</code>,通过<code>check_reg_idx</code>函数检查这个索引是否有效,然后返回一个指向寄存器名称的指针.</p>
<p>文件的末尾是预处理器宏<code>__RISCV_REG_H__</code>的结束部分,标记这个头文件的结束.</p>
<h4 id="check_reg_idxint-idx">关于check_reg_idx(int idx)<a class="headerlink" href="#check_reg_idxint-idx" title="Anchor link to this section for reference">&para;</a></h4>
<p>这段代码定义了一个名为<code>check_reg_idx</code>的内联函数,这个函数用于检查寄存器索引是否有效.</p>
<p>函数接受一个整数参数<code>idx</code>,这个参数代表要检查的寄存器索引.</p>
<p>在函数体中,首先使用了一个名为<code>IFDEF</code>的宏.这个宏的行为取决于<code>CONFIG_RT_CHECK</code>是否被定义.如果<code>CONFIG_RT_CHECK</code>被定义,那么<code>assert</code>语句会被执行.这个<code>assert</code>语句会检查<code>idx</code>是否在0和<code>MUXDEF(CONFIG_RVE, 16, 32)</code>之间.如果<code>idx</code>不在这个范围内,那么<code>assert</code>会失败,程序会打印一个错误消息并终止.如果<code>CONFIG_RT_CHECK</code>没有被定义,那么<code>assert</code>语句会被忽略.</p>
<p><code>MUXDEF</code>是另一个宏,它根据<code>CONFIG_RVE</code>的值选择两个选项之一.如果<code>CONFIG_RVE</code>被定义,那么<code>MUXDEF</code>返回16,否则返回32.这意味着如果RISC-V处理器启用了RV32E扩展（这是一个只有16个整数寄存器的扩展）,那么寄存器索引的上限是16,否则上限是32.</p>
<p>最后,函数返回传入的索引.这样,你可以在一个表达式中使用这个函数来检查寄存器索引,并在同一时间获取这个索引.例如,<code>gpr[check_reg_idx(idx)]</code>会检查<code>idx</code>是否有效,如果有效,就返回对应的寄存器.</p>
<h4 id="gprint-idx">关于gpr(int idx)<a class="headerlink" href="#gprint-idx" title="Anchor link to this section for reference">&para;</a></h4>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">  </span><span class="n">word_t</span><span class="w"> </span><span class="n">gpr</span><span class="p">[</span><span class="n">MUXDEF</span><span class="p">(</span><span class="n">CONFIG_RVE</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)];</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">  </span><span class="n">vaddr_t</span><span class="w"> </span><span class="n">pc</span><span class="p">;</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="p">}</span><span class="w"> </span><span class="n">MUXDEF</span><span class="p">(</span><span class="n">CONFIG_RV64</span><span class="p">,</span><span class="w"> </span><span class="n">riscv64_CPU_state</span><span class="p">,</span><span class="w"> </span><span class="n">riscv32_CPU_state</span><span class="p">);</span>
</code></pre></div>
这段代码定义了一个名为<code>gpr</code>的宏,用于访问CPU的通用寄存器.</p>
<p>想要彻底了解底层,非得搞明白这些宏技巧</p>
<h5 id="concat_tempxy">concat_temp(x,y)<a class="headerlink" href="#concat_tempxy" title="Anchor link to this section for reference">&para;</a></h5>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="cp">#define concat_temp(x, y) x ## y</span>
</code></pre></div>
这段代码定义了一个名为<code>concat_temp</code>的预处理器宏,这个宏用于连接两个预处理器标记.</p>
<p>在C语言中,预处理器宏可以接受参数,并在宏展开时替换这些参数.在这个宏的定义中,<code>x</code>和<code>y</code>是参数,<code>##</code>是连接运算符.</p>
<p>连接运算符<code>##</code>会将它左边和右边的标记连接成一个新的标记.例如,如果你写<code>concat_temp(a, b)</code>,那么预处理器会将这个宏展开为<code>ab</code>.</p>
<p>这个宏可以用于生成新的标识符,例如变量名或函数名.例如,如果你有一些变量<code>var1</code>、<code>var2</code>、<code>var3</code>等,你可以使用这个宏和一个循环来访问这些变量,而不需要为每个变量写单独的代码.</p>
<p>请注意,预处理器宏在编译时进行展开,所以它们不能用于动态生成标识符.所有的标识符都必须在编译时确定.</p>
<h5 id="define-muxdefmacro-x-y-mux_macro_property__p_def_-macro-x-y">#define MUXDEF(macro, X, Y)  MUX_MACRO_PROPERTY(__P_DEF_, macro, X, Y)<a class="headerlink" href="#define-muxdefmacro-x-y-mux_macro_property__p_def_-macro-x-y" title="Anchor link to this section for reference">&para;</a></h5>
<p><code>MUXDEF</code>的含金量就是根据macro的定义与否来选择X或Y</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="cp">#define CHOOSE2nd(a, b, ...) b</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="cp">#define MUX_WITH_COMMA(contain_comma, a, b) CHOOSE2nd(contain_comma a, b)</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="cp">#define MUX_MACRO_PROPERTY(p, macro, a, b) MUX_WITH_COMMA(concat(p, macro), a, b)</span>
</code></pre></div>
这段代码定义了一个名为<code>CHOOSE2nd</code>的预处理器宏,这个宏接受至少两个参数,并返回第二个参数.</p>
<p>在C语言中,预处理器宏可以接受参数,并在宏展开时替换这些参数.在这个宏的定义中,<code>a</code>、<code>b</code>和<code>__VA_ARGS__</code>是参数.</p>
<p><code>a</code>和<code>b</code>分别代表第一个和第二个参数,<code>__VA_ARGS__</code>是一个特殊的标记,代表所有其他的参数.这个标记只能在接受可变数量参数的宏中使用.</p>
<p>在这个宏的定义中,只有<code>b</code>被使用,所以这个宏会忽略第一个参数和所有其他的参数,只返回第二个参数.</p>
<p>例如,如果你写<code>CHOOSE2nd(1, 2, 3, 4)</code>,那么预处理器会将这个宏展开为<code>2</code>.</p>
<p>这段代码定义了三个预处理器宏,它们一起实现了一个复杂的宏选择机制.</p>
<p>首先,<code>CHOOSE2nd(a, b, ...)</code>宏接受至少两个参数,并返回第二个参数.这个宏在后面的宏中被用作一个辅助工具,用于选择两个选项之一.</p>
<p>然后,<code>MUX_WITH_COMMA(contain_comma, a, b)</code>宏使用<code>CHOOSE2nd</code>宏来根据<code>contain_comma</code>参数是否包含逗号来选择<code>a</code>或<code>b</code>.如果<code>contain_comma</code>包含逗号,那么宏会展开为<code>a</code>,否则宏会展开为<code>b</code>.这个宏利用了C预处理器的一个特性,即在宏参数中,如果一个参数包含逗号,但是没有被括号包围,那么这个参数会被分割成多个参数.</p>
<p>最后,<code>MUX_MACRO_PROPERTY(p, macro, a, b)</code>宏使用<code>MUX_WITH_COMMA</code>宏来根据<code>p</code>和<code>macro</code>连接后的结果是否包含逗号来选择<code>a</code>或<code>b</code>.这个宏可以用于检查一个宏是否定义了某个属性.例如,如果你有一个名为<code>FEATURE</code>的宏,你可以使用<code>MUX_MACRO_PROPERTY(FEATURE_, CONFIG_FEATURE, a, b)</code>来检查<code>CONFIG_FEATURE</code>是否被定义.如果<code>CONFIG_FEATURE</code>被定义,那么宏会展开为<code>a</code>,否则宏会展开为<code>b</code>.</p>
<hr />
<blockquote>
<p><code>comma</code>是逗号的意思(哈基米是什么意思呢?)
<code>Concat</code> 是 "concatenate" 的缩写形式,指的是将两个或多个字符串或序列连接在一起的操作.在编程语言和计算机科学中,"concatenate" 是一个常见的术语,用于描述将两个或多个字符串、数组、列表或其他序列按顺序连接成一个更大的序列的操作.</p>
</blockquote>
<hr />
<p>在许多编程语言中,都有专门的函数或操作符用于执行连接操作.例如,在 Python 中,可以使用加号 <code>+</code> 运算符来连接字符串或列表.在其他语言中,也可能会有类似的操作符或函数,用于连接不同的数据结构.</p>
<p>因此,"concat" 可以被理解为执行连接操作的动作或功能,通常用于描述在编程中执行这种操作的过程.</p>
<p>当然可以.在C语言中,你可以使用预处理器指令<code>#define</code>来定义宏,然后在代码中使用这些宏.以下是如何使用你提供的宏的一个例子：</p>
<p>首先,你需要定义一个<code>concat</code>宏,因为<code>MUX_MACRO_PROPERTY</code>宏中用到了它.<code>concat</code>宏用于连接两个预处理器标记：</p>
<h3 id="_6">一些哈批例子<a class="headerlink" href="#_6" title="Anchor link to this section for reference">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="cp">#define concat(a, b) a ## b</span>
</code></pre></div>
<p>然后,你可以定义一些特性宏,例如：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="cp">#define FEATURE_A</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="cp">#define FEATURE_B 1,</span>
</code></pre></div>
<p>最后,你可以使用<code>MUX_MACRO_PROPERTY</code>宏来检查一个特性是否被定义：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="n">MUX_MACRO_PROPERTY</span><span class="p">(</span><span class="n">FEATURE_</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;A is defined&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;A is not defined&quot;</span><span class="p">)</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="n">MUX_MACRO_PROPERTY</span><span class="p">(</span><span class="n">FEATURE_</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;B is defined&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;B is not defined&quot;</span><span class="p">)</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="n">MUX_MACRO_PROPERTY</span><span class="p">(</span><span class="n">FEATURE_</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;C is defined&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;C is not defined&quot;</span><span class="p">)</span>
</code></pre></div>
<p>在这个例子中,<code>FEATURE_A</code>被定义,但是没有值,<code>FEATURE_B</code>被定义,并且有一个值（1和一个逗号）,<code>FEATURE_C</code>没有被定义.</p>
<p><code>MUX_MACRO_PROPERTY</code>宏会将<code>FEATURE_</code>和<code>A</code>连接,得到<code>FEATURE_A</code>,然后检查这个宏是否包含逗号.因为<code>FEATURE_A</code>没有值,所以它不包含逗号,所以<code>MUX_MACRO_PROPERTY</code>宏会返回"A is not defined".</p>
<p>对于<code>FEATURE_B</code>,<code>MUX_MACRO_PROPERTY</code>宏会将<code>FEATURE_</code>和<code>B</code>连接,得到<code>FEATURE_B</code>,然后检查这个宏是否包含逗号.因为<code>FEATURE_B</code>的值是1和一个逗号,所以它包含逗号,所以<code>MUX_MACRO_PROPERTY</code>宏会返回"B is defined".</p>
<p>对于<code>FEATURE_C</code>,<code>MUX_MACRO_PROPERTY</code>宏会将<code>FEATURE_</code>和<code>C</code>连接,得到<code>FEATURE_C</code>,然后检查这个宏是否包含逗号.因为<code>FEATURE_C</code>没有被定义,所以它不包含逗号,所以<code>MUX_MACRO_PROPERTY</code>宏会返回"C is not defined".</p>
<h3 id="_7">作用<a class="headerlink" href="#_7" title="Anchor link to this section for reference">&para;</a></h3>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="c1">// macro testing</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="c1">// See https://stackoverflow.com/questions/26099745/test-if-preprocessor-symbol-is-defined-inside-macro</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="cp">#define CHOOSE2nd(a, b, ...) b</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="cp">#define MUX_WITH_COMMA(contain_comma, a, b) CHOOSE2nd(contain_comma a, b)</span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="cp">#define MUX_MACRO_PROPERTY(p, macro, a, b) MUX_WITH_COMMA(concat(p, macro), a, b)</span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="c1">// define placeholders for some property</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="cp">#define __P_DEF_0  X,</span>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="cp">#define __P_DEF_1  X,</span>
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a><span class="cp">#define __P_ONE_1  X,</span>
<a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a><span class="cp">#define __P_ZERO_0 X,</span>
<a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a><span class="c1">// define some selection functions based on the properties of BOOLEAN macro</span>
<a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a><span class="cp">#define MUXDEF(macro, X, Y)  MUX_MACRO_PROPERTY(__P_DEF_, macro, X, Y)</span>
<a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a>
<a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a><span class="w">  </span><span class="n">word_t</span><span class="w"> </span><span class="n">gpr</span><span class="p">[</span><span class="n">MUXDEF</span><span class="p">(</span><span class="n">CONFIG_RVE</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)];</span>
<a id="__codelineno-36-16" name="__codelineno-36-16" href="#__codelineno-36-16"></a><span class="w">  </span><span class="n">vaddr_t</span><span class="w"> </span><span class="n">pc</span><span class="p">;</span>
<a id="__codelineno-36-17" name="__codelineno-36-17" href="#__codelineno-36-17"></a><span class="p">}</span><span class="w"> </span><span class="n">MUXDEF</span><span class="p">(</span><span class="n">CONFIG_RV64</span><span class="p">,</span><span class="w"> </span><span class="n">riscv64_CPU_state</span><span class="p">,</span><span class="w"> </span><span class="n">riscv32_CPU_state</span><span class="p">);</span>
</code></pre></div>
可以根据CONFIG_RV64来命名结构体,这个宏可以根据CONFIG_RVE来选择16或者32,这个宏可以根据CONFIG_RVE来选择16或者32,这个宏可以根据CONFIG_RV64来选择riscv64_CPU_state或者riscv32_CPU_state.但是我发现__P_DEF_0和__P_DEF_1都是X,这样怎么区分?</p>
<p>助教的解答和我的思考,这个主要是跟双井号拼接用法以及【CHOOSE2nd(contain_comma a, b)】（一定注意contain_comma和a之间是没有逗号的）有关
1、如果CONFIG_RV64没有被定义,则有【MUX_MACRO_PROPERTY(__P_DEF_, CONFIG_RV64, riscv64_CPU_state, riscv32_CPU_state)】,其中的【__P_DEF_】和【CONFIG_RV64】都是空,双井号拼接也是空,于是有【CHOOSE2nd(riscv64_CPU_state, riscv32_CPU_state)】,此时取的是riscv32_CPU_state2、同理如果CONFIG_RV64被定义,则有【MUX_MACRO_PROPERTY(__P_DEF_, CONFIG_RV64, riscv64_CPU_state, riscv32_CPU_state)】,字符串拼接后形成【CHOOSE2nd(__P_DEF_1, riscv64_CPU_state, riscv32_CPU_state)】,此时取的是riscv64_CPU_state
总之,__P_DEF_0和__P_DEF_1的值有作用,但是不是直接作用在这个地方,而是通过字符串拼接后的结果来体现作用的.</p>
<p>还要考虑到当选择riscv32时<code>generate/auto.h</code>中的<code>CONFIG_RV64</code>是没有定义的,如同助教的解答,__P_DEF和CONFIG_RV64都是空,所以最终选择的是riscv32_CPU_state,而当<code>CONFIG_RV64</code>被定义时,最终选择的是riscv64_CPU_state.</p>
<blockquote>
<p>要注意的地方就是当宏没有被定义时,默认是<strong>空</strong></p>
</blockquote>
<h4 id="_8">直接启动出现重复打印命令的问题<a class="headerlink" href="#_8" title="Anchor link to this section for reference">&para;</a></h4>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>gdb<span class="w"> </span>-s<span class="w"> </span>/home/along/ysyx-workbench/nemu/build/riscv32-nemu-interpreter<span class="w"> </span>--args<span class="w"> </span>/home/along/ysyx-workbench/nemu/build/riscv32-nemu-interpreter<span class="w"> </span>--log<span class="o">=</span>/home/along/ysyx-workbench/nemu/build/nemu-log.txt<span class="w">  </span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>gdb<span class="w"> </span>-s<span class="w"> </span>/home/along/ysyx-workbench/nemu/build/riscv32-nemu-interpreter<span class="w"> </span>--args<span class="w"> </span>/home/along/ysyx-workbench/nemu/build/riscv32-nemu-interpreter<span class="w"> </span>
</code></pre></div>
直接启动应该是log导致的,会将本来输出到log的输出到stdin,所以会重复打印</p>
<h3 id="_9">内存扫描<a class="headerlink" href="#_9" title="Anchor link to this section for reference">&para;</a></h3>
<p>内存是什么?
这段代码是NEMU（一个简单的计算机模拟器）中的一部分,用于处理物理地址空间的读写操作.</p>
<p>首先,代码定义了一个名为<code>pmem</code>的静态数组,用于模拟物理内存.如果定义了<code>CONFIG_PMEM_MALLOC</code>,则<code>pmem</code>会被定义为一个指针,并在<code>init_mem</code>函数中通过<code>malloc</code>分配内存.否则,<code>pmem</code>会被定义为一个大小为<code>CONFIG_MSIZE</code>的数组.</p>
<p><code>guest_to_host</code>和<code>host_to_guest</code>这两个函数用于将客户机地址（即虚拟机中的地址）转换为主机地址（即模拟器中的地址）,反之亦然.这两个函数通过加减<code>CONFIG_MBASE</code>（即物理内存的基地址）来进行转换.</p>
<p><code>pmem_read</code>和<code>pmem_write</code>这两个函数用于读写物理内存.它们首先将物理地址转换为主机地址,然后调用<code>host_read</code>或<code>host_write</code>来进行实际的读写操作.</p>
<p><code>out_of_bound</code>函数用于处理地址越界的情况.如果试图访问的地址不在物理内存的范围内,这个函数会被调用,并打印出错误信息.</p>
<p><code>init_mem</code>函数用于初始化物理内存.如果定义了<code>CONFIG_PMEM_MALLOC</code>,它会分配内存给<code>pmem</code>.如果定义了<code>CONFIG_MEM_RANDOM</code>,它会用随机数填充物理内存.</p>
<p><code>paddr_read</code>和<code>paddr_write</code>这两个函数是物理地址空间的读写接口.它们首先检查要访问的地址是否在物理内存的范围内.如果是,它们会调用<code>pmem_read</code>或<code>pmem_write</code>来进行读写操作.如果不是,它们会检查是否定义了<code>CONFIG_DEVICE</code>.如果定义了<code>CONFIG_DEVICE</code>,它们会调用<code>mmio_read</code>或<code>mmio_write</code>来进行读写操作.如果地址既不在物理内存的范围内,也没有定义<code>CONFIG_DEVICE</code>,它们会调用<code>out_of_bound</code>来处理地址越界的情况.</p>
<h4 id="pmem_read">pmem_read<a class="headerlink" href="#pmem_read" title="Anchor link to this section for reference">&para;</a></h4>
<p>这段代码定义了一个名为<code>host_read</code>的内联函数,它用于从主机内存中读取数据.这个函数接受两个参数：<code>addr</code>和<code>len</code>.<code>addr</code>是一个指向要读取的内存地址的指针,<code>len</code>是要读取的数据的长度（以字节为单位）.</p>
<p>函数体是一个<code>switch</code>语句,它根据<code>len</code>的值来决定如何读取数据.如果<code>len</code>是1,那么就读取一个字节（8位）的数据,并将其作为<code>uint8_t</code>类型返回.如果<code>len</code>是2,那么就读取两个字节（16位）的数据,并将其作为<code>uint16_t</code>类型返回.如果<code>len</code>是4,那么就读取四个字节（32位）的数据,并将其作为<code>uint32_t</code>类型返回.</p>
<p>如果定义了<code>CONFIG_ISA64</code>宏（这通常意味着我们正在使用64位的指令集架构）,并且<code>len</code>是8,那么就读取八个字节（64位）的数据,并将其作为<code>uint64_t</code>类型返回.</p>
<p>如果<code>len</code>的值不是1、2、4或8（在使用64位指令集架构时）,那么就会执行<code>default</code>分支.如果定义了<code>CONFIG_RT_CHECK</code>宏（这通常意味着我们正在进行运行时检查）,那么就会执行<code>assert(0)</code>,这会导致程序在此处断言失败并终止.如果没有定义<code>CONFIG_RT_CHECK</code>宏,那么就会返回0.</p>
<p>总的来说,<code>host_read</code>函数是一个通用的内存读取函数,它可以读取不同长度的数据,并将其作为适当的无符号整数类型返回.
调用关系链条
vaddr_read-&gt;paddr_read-&gt;pmem_read-&gt;host_read
我想用好宏=&gt;根据事先定义好的宏来决定vaddr_read(expr,len)中的len</p>
<h4 id="hostguest">host和guest<a class="headerlink" href="#hostguest" title="Anchor link to this section for reference">&para;</a></h4>
<p>在虚拟化技术中,"host"和"guest"是常用的术语.</p>
<p>"Host"通常指的是运行虚拟化软件的物理机器或操作系统.例如,如果你在Windows系统上运行一个虚拟机软件（如VMware或VirtualBox）,那么Windows就是host.</p>
<p>"Guest"则指的是运行在虚拟机上的操作系统.继续上面的例子,如果你在VMware或VirtualBox中安装了一个Linux系统,那么这个Linux系统就是guest.</p>
<p>在你提到的NEMU模拟器中,"host"指的是运行NEMU的操作系统,"guest"指的是被NEMU模拟的计算机系统."guest_to_host"和"host_to_guest"这两个函数用于在host和guest之间转换地址,因为虚拟机中的地址（guest地址）和物理机器中的地址（host地址）是不同的."Guest"和"Host"的本意来自英语中的日常用法.</p>
<p>"Host"在英语中的原意是“主人”或“主持人”,在特定的环境或事件中,主人通常是提供空间、设施或资源的一方.</p>
<p>"Guest"在英语中的原意是“客人”或“访客”,在特定的环境或事件中,客人通常是被邀请来使用或享受主人提供的空间、设施或资源的一方.</p>
<p>在计算机科学中,这两个词被借用来描述虚拟化环境中的两个角色."Host"是运行虚拟化软件的物理机器或操作系统,提供硬件资源和运行环境,就像一个“主人”."Guest"是运行在虚拟机上的操作系统或应用程序,使用由"Host"提供的资源和环境,就像一个“客人”.</p>
<p>=== *haddr和paddr切换</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">pmem</span><span class="p">[</span><span class="n">CONFIG_MSIZE</span><span class="p">]</span><span class="n">PG_ALIGN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="o">*</span><span class="n">haddr</span><span class="o">=</span><span class="n">pmem</span><span class="o">+</span><span class="n">paddr</span><span class="o">-</span><span class="n">CONFIG_MIZE</span>
</code></pre></div>
x86的物理内存是从0开始编址的, 但对于一些ISA来说却不是这样, 例如mips32和riscv32的物理地址均从 0x80000000开始. 因此对于mips32和riscv32, 其 CONFIG_MBASE将会被定义成 0x80000000. 将来CPU访问内存时, 我们会将CPU将要访问的内存地址映射到 pmem中的相应偏移位置, 这是通过 nemu/src/memory/paddr.c中的 guest_to_host()函数实现的. 例如如果mips32的CPU打算访问内存地址 0x80000000, 我们会让它最终访问 pmem[0], 从而可以正确访问客户程序--log=/home/along/ysyx-workbench/nemu/build/nemu-log.txt  却不是这样, 例如mips32和riscv32的物理地址均从0x80000000开始. 因此对于mips32和riscv32, 其CONFIG_MBASE将会被定义成0x8000000</p>
<p>内存通过这个pmem大数组来表示</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>pmem:
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>CONFIG_MBASE      RESET_VECTOR
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>      |                 |
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a>      v                 v
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a>      -----------------------------------------------
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a>      |                 |                  |
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a>      |                 |    guest prog    |
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a>      |                 |                  |
<a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a>      -----------------------------------------------
<a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a>                        ^
<a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a>                        |
<a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a>                       pc
</code></pre></div>
<h3 id="copy-paste">copy-paste<a class="headerlink" href="#copy-paste" title="Anchor link to this section for reference">&para;</a></h3>
<p>每次写到这种代码的固然有点难蚌,但是还是南蚌.比如给cmd_x写错误处理代码时候,我想直接给每个这样的函数在遇到无参数的时候都整个参数提醒,
其实只要输出这些函数在cmd_table里的usage介绍就行了,但是懒惰让我直接接受copilot给我的copy-paste</p>
<h3 id="_10">表达式实现<a class="headerlink" href="#_10" title="Anchor link to this section for reference">&para;</a></h3>
<p>在TRM中, 寄存器(包括PC)和内存中的值唯一地确定了计算机的一个状态. 因此从道理上来讲, 打印寄存器和扫描内存这两个功能一定可以帮助我们调试出所有的问题. 但为了方便使用, 我们还希望简易调试器能帮我们计算一些带有寄存器和内存的表达式. 所以你需要在简易调试器中添加表达式求值的功能. 为了简单起见, 我们先来考虑数学表达式的求值实现.
数学表达式求值
给你一个表达式的字符串</p>
<p><code>5 + 4 * 3 / 2 - 1</code>
你如何求出它的值? 表达式求值是一个很经典的问题, 以至于有很多方法来解决它. 我们在所需知识和难度两方面做了权衡, 在这里使用如下方法来解决表达式求值的问题:</p>
<p>首先识别出表达式中的单元
根据表达式的归纳定义进行递归求值
词法分析
"词法分析"这个词看上去很高端, 说白了就是做上面的第1件事情, "识别出表达式中的单元". 这里的"单元"是指有独立含义的子串, 它们正式的称呼叫<code>token</code>. 具体地说, 我们需要在上述表达式中识别出<code>5</code>, <code>+</code>, <code>4</code>, <code>*</code>, <code>3</code>, <code>/</code>, <code>2</code>, <code>-</code>, <code>1</code>这些<code>token</code>. 你可能会觉得这是一件很简单的事情, 但考虑以下的表达式:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="s2">&quot;0x80100000+   (</span><span class="nv">$a0</span><span class="s2"> +5)*4 - *(  </span><span class="nv">$t1</span><span class="s2"> + 8) + number&quot;</span>
</code></pre></div>
<p>它包含更多的功能, 例如十六进制整数(0x80100000), 小括号, 访问寄存器($a0), 指针解引用(第二个*), 访问变量(number). 事实上, 这种复杂的表达式在调试过程中经常用到, 而且你需要在空格数目不固定(0个或多个)的情况下仍然能正确识别出其中的token. 当然你仍然可以手动进行处理(如果你喜欢挑战性的工作的话), 一种更方便快捷的做法是使用正则表达式. 正则表达式可以很方便地匹配出一些复杂的pattern, 是程序员必须掌握的内容. 如果你从来没有接触过正则表达式, 请查阅相关资料. 在实验中, 你只需要了解正则表达式的一些基本知识就可以了(例如元字符).</p>
<h4 id="_11">上次对表达式的实现很蠢<a class="headerlink" href="#_11" title="Anchor link to this section for reference">&para;</a></h4>
<p>我想有个好一点的实现?二叉树?或者还是什么其他的东西?但是先别急,先看看这个实现.如果你喜欢挑战性的工作,一种更方便快捷的方法是使用正则表达式</p>
<h4 id="_12">如何调试<a class="headerlink" href="#_12" title="Anchor link to this section for reference">&para;</a></h4>
<p>不要使用"目光调试法", 要思考如何用正确的工具和方法帮助调试
程序设计课上盯着几十行的程序, 你或许还能在大脑中像NEMU那样模拟程序的执行过程; 但程序规模大了之后, 很快你就会放弃的: 你的大脑不可能模拟得了一个巨大的状态机
我们学习计算机是为了学习计算机的工作原理, 而不是学习如何像计算机那样机械地工作
使用<code>assert()</code>设置检查点, 拦截非预期情况
例如<code>assert(p != NULL)</code>就可以拦截由空指针解引用引起的段错误
结合对程序执行行为的理解, 使用<code>printf()</code>查看程序执行的情况(注意字符串要换行)
<code>printf()</code>输出任意信息可以检查代码可达性: 输出了相应信息, 当且仅当相应的代码块被执行
<code>printf()</code>输出变量的值, 可以检查其变化过程与原因
使用GDB观察程序的任意状态和行为
打印变量, 断点, 监视点, 函数调用栈...
如果你突然觉得上述方法很有道理, 说明你在程序设计课上没有受到该有的训练.</p>
<p>三个对调试有用的宏(在 <code>nemu/include/debug.h中定义</code>)
<code>Log()</code>是 <code>printf()</code>的升级版, 专门用来输出调试信息, 同时还会输出使用 <code>Log()</code>所在的源文件, 行号和函数. 当输出的调试信息过多的时候, 可以很方便地定位到代码中的相关位置（非常好用！！！！非常推荐）
<code>Assert()</code>是 <code>assert()</code>的升级版, 当测试条件为假时, 在<code>assertion fail</code>之前可以输出一些信息
panic()用于输出信息并结束程序, 相当于无条件的<code>assertion fail</code></p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="cp">#define Log(format, ...) \</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="cp">    _Log(ANSI_FMT(&quot;[%s:%d %s] &quot; format, ANSI_FG_BLUE) &quot;\n&quot;, \</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="cp">        __FILE__, __LINE__, __func__, ## __VA_ARGS__)</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="cp">#define Assert(cond, format, ...) \</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="cp">  do { \</span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="cp">    if (!(cond)) { \</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="cp">      MUXDEF(CONFIG_TARGET_AM, printf(ANSI_FMT(format, ANSI_FG_RED) &quot;\n&quot;, ## __VA_ARGS__), \</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="cp">        (fflush(stdout), fprintf(stderr, ANSI_FMT(format, ANSI_FG_RED) &quot;\n&quot;, ##  __VA_ARGS__))); \</span>
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="cp">      IFNDEF(CONFIG_TARGET_AM, extern FILE* log_fp; fflush(log_fp)); \</span>
<a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="cp">      extern void assert_fail_msg(); \</span>
<a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a><span class="cp">      assert_fail_msg(); \</span>
<a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a><span class="cp">      assert(cond); \</span>
<a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a><span class="cp">    } \</span>
<a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a><span class="cp">  } while (0)</span>
</code></pre></div>
这段代码是一个在C语言中定义的宏,名为<code>Log</code>.宏在C语言中是一种预处理器指令,它们在编译代码之前由预处理器处理.宏可以用来创建可以在代码中重复使用的代码片段.</p>
<p><code>Log</code>宏接受两个参数：一个格式字符串（<code>format</code>）和一个可变参数列表（<code>__VA_ARGS__</code>）.这个宏的主要功能是生成一条日志消息,并将其打印出来.</p>
<p><code>_Log</code>函数是这个宏的核心,它负责生成和打印日志消息.<code>_Log</code>函数的第一个参数是一个格式字符串,它使用<code>ANSI_FMT</code>宏和<code>ANSI_FG_BLUE</code>宏来设置消息的颜色为蓝色.格式字符串中的<code>[%s:%d %s]</code>用于插入文件名、行号和函数名,这些信息由<code>__FILE__</code>、<code>__LINE__</code>和<code>__func__</code>预处理器宏提供.<code>format</code>参数是用户提供的消息格式,它被直接插入到格式字符串中.</p>
<p><code>## __VA_ARGS__</code>是一个特殊的预处理器操作符,它用于处理可变参数列表.在这个宏中,它将用户提供的所有参数插入到<code>_Log</code>函数的参数列表中.</p>
<p>总的来说,这个<code>Log</code>宏提供了一种方便的方式来生成和打印带有文件名、行号和函数名的日志消息.</p>
<h4 id="_13">如何编辑<a class="headerlink" href="#_13" title="Anchor link to this section for reference">&para;</a></h4>
<p>在VS Code中,你可以使用"多光标编辑"功能来同时编辑多个相同的词.以下是使用这个功能的步骤：</p>
<ol>
<li>
<p>首先,选择你想要编辑的词.</p>
</li>
<li>
<p>然后,按<code>Ctrl+D</code>（在macOS上是<code>Cmd+D</code>）.这将在下一个相同的词处添加一个新的光标.</p>
</li>
<li>
<p>重复按<code>Ctrl+D</code>（或<code>Cmd+D</code>）,直到你为所有想要编辑的词添加了光标.</p>
</li>
<li>
<p>现在,你可以同时编辑所有的词.当你输入或删除字符时,所有的光标都会执行相同的操作.</p>
</li>
</ol>
<p>请注意,你也可以使用<code>Ctrl+Shift+L</code>（在macOS上是<code>Cmd+Shift+L</code>）一次性为所有相同的词添加光标.</p>
<h4 id="static-inline">static 和 inline<a class="headerlink" href="#static-inline" title="Anchor link to this section for reference">&para;</a></h4>
<ul>
<li>什么是translation unit</li>
</ul>
<p>"Translation unit" 是指编译器处理的最小单元,通常是一个源文件（如 <code>.c</code> 文件）以及它所包含的所有包含文件（头文件）的内容.在编译过程中,编译器将每个源文件及其包含的头文件合并成一个称为 translation unit 的单元进行处理.</p>
<p>每个 translation unit 在编译时都会生成一个目标文件（object file）,最终在链接阶段将这些目标文件合并成可执行文件.</p>
<p>一个 translation unit 可以包含如下内容：</p>
<ol>
<li>
<p><strong>全局变量和函数的声明和定义</strong>：包括静态全局变量和函数.</p>
</li>
<li>
<p><strong>函数的定义</strong>：函数的实现.</p>
</li>
<li>
<p><strong>宏定义</strong>：在源文件中定义的预处理器宏.</p>
</li>
<li>
<p><strong>类型定义</strong>：包括结构体、联合体和枚举等类型的定义.</p>
</li>
</ol>
<p>在编译时,编译器将会对每个 translation unit 进行独立编译,并生成对应的目标文件.然后,链接器将这些目标文件合并成一个可执行文件或者库文件.</p>
<p>在 C 和 C++ 中,每个源文件通常对应一个 translation unit.因此,了解 translation unit 的概念对于理解编译和链接过程非常重要.
+ 两个translaton unit同时引用,就导致multiple definition</p>
<p>是的,当两个或多个独立的 translation units（通常是不同的源文件）中都定义了相同的全局变量、函数或其他具有外部链接属性的实体时,就会出现多重定义（multiple definition）错误.</p>
<p>这种错误通常在链接阶段被检测到,因为链接器负责将各个 translation units 的目标文件合并成最终的可执行文件或者库文件.当链接器在合并时发现多个 translation units 中存在相同名称的全局变量或函数时,就会报告多重定义错误.</p>
<p>解决这种错误的方法通常有以下几种：</p>
<ol>
<li>
<p><strong>使用 <code>static</code> 修饰符</strong>：如果某个全局变量或函数只在当前文件内部使用,可以使用 <code>static</code> 修饰符将其声明为具有内部链接属性,从而避免与其他文件的实体冲突.</p>
</li>
<li>
<p><strong>使用 <code>extern</code> 关键字进行声明</strong>：如果某个全局变量或函数需要在多个文件之间共享,可以在其中一个文件中进行定义,而在其他文件中使用 <code>extern</code> 关键字进行声明,这样可以避免多重定义错误.</p>
</li>
<li>
<p><strong>使用头文件</strong>：将函数声明、全局变量声明以及其他外部实体的声明放在头文件中,在需要使用这些实体的文件中包含相应的头文件,这样可以确保每个文件都使用同一份定义,避免多重定义错误.</p>
</li>
<li>
<p><strong>使用命名空间（C++）</strong>：在 C++ 中,可以使用命名空间来避免全局作用域中的名称冲突,这样即使在不同的文件中有相同名称的实体,它们也不会发生冲突.</p>
</li>
</ol>
<p>通过以上方法,可以有效地避免多重定义错误,并确保程序能够正确地链接和执行.</p>
<ul>
<li>什么是extern linkage什么是internal linkage</li>
</ul>
<p>在 C 和 C++ 中,全局变量、函数和其他实体可以具有不同的链接属性,这些链接属性决定了这些实体的可见性和共享性.主要有两种链接属性：</p>
<ol>
<li><strong>外部链接（External Linkage）</strong>：具有外部链接的实体在整个程序中可见,可以被其他 translation units（独立的编译单元,通常是不同的源文件）访问和使用.这意味着,如果在一个文件中定义了具有外部链接的实体,其他文件也可以通过声明来引用它,然后在链接时将其合并.通常,全局变量和函数默认具有外部链接.</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="c1">// 文件1.c</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">global_variable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="c1">// 具有外部链接的全局变量</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="c1">// 文件2.c</span>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="k">extern</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">global_variable</span><span class="p">;</span><span class="w"> </span><span class="c1">// 引用文件1.c中的全局变量</span>
</code></pre></div>
<ol>
<li><strong>内部链接（Internal Linkage）</strong>：具有内部链接的实体只在当前 translation unit 内可见,其他 translation units 无法访问.这意味着,具有内部链接的实体只能在定义它们的文件内部使用,其他文件无法直接引用它们.通常,使用 <code>static</code> 修饰符声明的全局变量和函数具有内部链接.</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="c1">// 文件1.c</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">internal_variable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w"> </span><span class="c1">// 具有内部链接的静态全局变量</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">internal_function</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="c1">// 具有内部链接的静态函数</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="c1">// 文件2.c</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="k">extern</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">internal_variable</span><span class="p">;</span><span class="w"> </span><span class="c1">// 错误：无法引用具有内部链接的变量</span>
</code></pre></div>
<p>总之,外部链接的实体可以在多个文件之间共享,而内部链接的实体只能在当前文件内部使用.这种区别使得我们能够更好地控制程序中实体的可见性和共享性.</p>
<h4 id="_14">为什么不能在头文件中实现函数?<a class="headerlink" href="#_14" title="Anchor link to this section for reference">&para;</a></h4>
<p><code>a.h</code>中实现一个<code>foo</code>函数,<code>b.c</code>和<code>c.c</code>都包含了<code>a.h</code>,这样会导致<code>foo</code>函数在<code>b.c</code>和<code>c.c</code>中都被定义了一次,这样会导致链接错误.所以在头文件中只能声明函数,不能实现函数.include就是将文件的内容复制到当前文件中,所以如果在头文件中实现函数,那么这个函数的定义就会被复制到每个包含这个头文件的文件中,从而导致多重定义错误.如果把foo的实现定义为static,那么就不会有这个问题,因为static修饰的函数只能在当前文件中使用.</p>
<h5 id="-werror-wall">-Werror -Wall<a class="headerlink" href="#-werror-wall" title="Anchor link to this section for reference">&para;</a></h5>
<p>-Werror选项会将所有的警告都视为错误,这意味着如果代码中有任何警告,编译器都会报错并停止编译.这样做的好处是可以确保代码的质量,因为任何警告都会被视为错误,开发人员就会更加注意避免产生警告.</p>
<p>-Wall选项会开启所有的警告,这意味着编译器会检查代码中的任何潜在问题并给出警告.这样做的好处是可以帮助开发人员发现代码中的潜在问题,并及时进行修复.</p>
<p>因此,使用-Werror -Wall选项可以确保代码的质量,并帮助开发人员发现潜在的问题,从而提高代码的可靠性和稳定性.</p>
<p>如果你在头文件中实现函数,并且给这个函数添加了<code>static</code>修饰符,那么这个函数就变成了静态函数.静态函数在C语言中有特殊的含义,它表示这个函数只在定义它的文件中可见.</p>
<p>这样做可以解决在头文件中实现函数可能出现的链接错误问题,因为每个包含这个头文件的源文件都会得到这个函数的一个私有拷贝,这些拷贝在链接阶段不会互相冲突.</p>
<p>然而,这仍然不能解决编译时间和代码重复的问题.每个包含这个头文件的源文件在编译时都会编译这个函数,这可能会导致编译时间增加.同时,每个源文件都会有这个函数的一份拷贝,这可能会导致生成的可执行文件的大小增加.</p>
<p>此外,这种做法也可能会导致代码的可读性和可维护性降低.通常,我们期望在头文件中看到的是接口声明,而在源文件中看到的是接口的实现.如果在头文件中看到了函数的实现,这可能会让人感到困惑.</p>
<p>因此,虽然在头文件中实现静态函数是可以的,但通常我们还是推荐在头文件中声明函数,在源文件中实现函数.</p>
<p>定义成static inline的函数,可以在头文件中定义,这样可以避免多重定义错误.这种函数会被编译器内联,会增加编译时间.这种函数适合于短小的函数,例如一些简单的getter和setter函数.</p>
<p>什么叫做被编译器内联? 内联函数是一种特殊的函数,它的定义和声明都在一起,通常在头文件中.内联函数的特点是在调用它的地方直接展开,而不是像普通函数一样生成一个函数调用.这样可以减少函数调用的开销,提高程序的执行效率.</p>
<h4 id="regex">关于regex<a class="headerlink" href="#regex" title="Anchor link to this section for reference">&para;</a></h4>
<p>REGEX(3)                                      Linux Programmer's Manual                                      REGEX(3)</p>
<p>NAME
       regcomp, regexec, regerror, regfree - POSIX regex functions
+ regcomp()
 regcomp()  is  used  to  compile  a  regular  expression into a form that is suitable for subsequent regexec()
       searches.</p>
<div class="highlight"><pre><span></span><code>   regcomp() is supplied with preg, a pointer to a pattern buffer storage area; regex, a pointer to the null-ter‐
   minated string and cflags, flags used to determine the type of compilation.

   All  regular  expression  searching  must be done via a compiled pattern buffer, thus regexec() must always be
   supplied with the address of a regcomp() initialized pattern buffer.
</code></pre></div>
<ul>
<li>regexec()</li>
</ul>
<p>```bash
       The regexec() function is used to match a null-terminated string against the precompiled pattern buffer preg.
       The string is pointed to by string and the length of the string is len.  The eflags argument is used to deter‐
       mine the type of matching that will be performed.
  The regmatch_t structure which is the type of pmatch is defined in <regex.h>.</p>
<div class="highlight"><pre><span></span><code>       typedef struct {
           regoff_t rm_so;
           regoff_t rm_eo;
       } regmatch_t;

   Each  rm_so  element that is not -1 indicates the start offset of the next largest substring match within the string.  The relative rm_eo element indicates the end offset of the match, which is the offset of the first character after the matching text.
</code></pre></div>
<p>```</p>
<h4 id="strtol">strtol()<a class="headerlink" href="#strtol" title="Anchor link to this section for reference">&para;</a></h4>
<p>strtol()是C语言中的一个标准库函数,用于将字符串转换为长整型数.它的函数原型如下：</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="kt">long</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">strtol</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">nptr</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">endptr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">base</span><span class="p">);</span>
</code></pre></div>
strtol()函数接受三个参数：<code>nptr</code>是一个指向待转换的字符串的指针,<code>endptr</code>是一个指向指针的指针,<code>base</code>是一个整数,表示转换时所使用的进制.</p>
<p>strtol()函数会将<code>nptr</code>指向的字符串转换为一个长整型数,并返回这个数.如果<code>endptr</code>不是NULL,那么strtol()会将<code>nptr</code>中第一个无法转换的字符的指针赋值给<code>endptr</code>.如果<code>endptr</code>是NULL,那么strtol()会忽略无法转换的字符.</p>
<p><code>base</code>参数表示转换时所使用的进制.如果<code>base</code>为0,那么strtol()会根据字符串的格式自动判断进制.如果<code>base</code>不为0,那么strtol()会将字符串按照指定的进制进行转换.</p>
<p>strtol()函数通常用于将字符串转换为整数,例如：</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="kt">char</span><span class="w"> </span><span class="n">str</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;12345&quot;</span><span class="p">;</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">endptr</span><span class="p">;</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="kt">long</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtol</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">endptr</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
</code></pre></div>
在这个例子中,<code>strtol()</code>函数将字符串<code>"12345"</code>转换为一个长整型数,并将结果存入<code>num</code>中.如果<code>endptr</code>不是NULL,那么<code>strtol()</code>会将<code>str</code>中第一个无法转换的字符的指针赋值给<code>endptr</code>.</p>
<p>总的来说,<code>strtol()</code>函数是一个用于将字符串转换为长整型数的标准库函数,它可以根据指定的进制进行转换,并且提供了一种方便的方法来处理转换失败的情况.</p>
<h4 id="strcmp">strcmp()<a class="headerlink" href="#strcmp" title="Anchor link to this section for reference">&para;</a></h4>
<p>strcmp()是C语言中的一个标准库函数,用于比较两个字符串.它的函数原型如下：</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">strcmp</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str2</span><span class="p">);</span>
</code></pre></div>
strcmp()函数接受两个参数：<code>str1</code>和<code>str2</code>分别是待比较的两个字符串的指针.</p>
<p>strcmp()函数会比较<code>str1</code>和<code>str2</code>指向的字符串,并返回一个整数.如果<code>str1</code>和<code>str2</code>相等,那么strcmp()会返回0.如果<code>str1</code>小于<code>str2</code>,那么strcmp()会返回一个小于0的整数.如果<code>str1</code>大于<code>str2</code>,那么strcmp()会返回一个大于0的整数.</p>
<p>strcmp()函数通常用于比较字符串,例如：</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="kt">char</span><span class="w"> </span><span class="n">str1</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;abc&quot;</span><span class="p">;</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="kt">char</span><span class="w"> </span><span class="n">str2</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;def&quot;</span><span class="p">;</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strcmp</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span><span class="w"> </span><span class="n">str2</span><span class="p">);</span>
</code></pre></div>
在这个例子中,<code>strcmp()</code>函数将字符串<code>"abc"</code>和<code>"def"</code>进行比较,并将结果存入<code>result</code>中.如果<code>result</code>的值为0,那么<code>str1</code>和<code>str2</code>相等.如果<code>result</code>的值小于0,那么<code>str1</code>小于<code>str2</code>.如果<code>result</code>的值大于0,那么<code>str1</code>大于<code>str2</code>.</p>
<p>总的来说,<code>strcmp()</code>函数是一个用于比较字符串的标准库函数,它可以方便地比较两个字符串,并根据比较结果返回一个整数.</p>
<h4 id="const-char-str">为什么要用const char *str<a class="headerlink" href="#const-char-str" title="Anchor link to this section for reference">&para;</a></h4>
<p>const char *str是一个指向字符的指针,它指向的字符是常量,不能被修改.这样做的好处是可以确保函数不会意外地修改传入的字符串,从而提高了代码的可靠性和可维护性.</p>
<h4 id="strncmp">strncmp()<a class="headerlink" href="#strncmp" title="Anchor link to this section for reference">&para;</a></h4>
<p>strncmp()是C语言中的一个标准库函数,用于比较两个字符串的前n个字符.它的函数原型如下：</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">strncmp</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str2</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</code></pre></div>
strncmp()函数接受三个参数：<code>str1</code>和<code>str2</code>分别是待比较的两个字符串的指针,<code>n</code>是一个无符号整数,表示要比较的字符数.</p>
<p>strncmp()函数会比较<code>str1</code>和<code>str2</code>指向的字符串的前n个字符,并返回一个整数.如果<code>str1</code>和<code>str2</code>的前n个字符相等,那么strncmp()会返回0.如果<code>str1</code>的前n个字符小于<code>str2</code>的前n个字符,那么strncmp()会返回一个小于0的整数.如果<code>str1</code>的前n个字符大于<code>str2</code>的前n个字符,那么strncmp()会返回一个大于0的整数.</p>
<p>strncmp()函数通常用于比较字符串的前n个字符,例如：</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="kt">char</span><span class="w"> </span><span class="n">str1</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;abc&quot;</span><span class="p">;</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="kt">char</span><span class="w"> </span><span class="n">str2</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;def&quot;</span><span class="p">;</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strncmp</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span><span class="w"> </span><span class="n">str2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
</code></pre></div>
在这个例子中,<code>strncmp()</code>函数将字符串<code>"abc"</code>和<code>"def"</code>的前2个字符进行比较,并将结果存入<code>result</code>中.如果<code>result</code>的值为0,那么<code>str1</code>和<code>str2</code>的前2个字符相等.如果<code>result</code>的值小于0,那么<code>str1</code>的前2个字符小于<code>str2</code>的前2个字符.如果<code>result</code>的值大于0,那么<code>str1</code>的前2个字符大于<code>str2</code>的前2个字符.</p>
<p>总的来说,<code>strncmp()</code>函数是一个用于比较字符串的前n个字符的标准库函数,它可以方便地比较两个字符串的前n个字符,并根据比较结果返回一个</p>
<h3 id="_15">表达式扩展<a class="headerlink" href="#_15" title="Anchor link to this section for reference">&para;</a></h3>
<p>表达式扩展的含金量 =&gt; 本来是仅支持常数运算,但是这并不能用在后面的调试工程 =&gt; 要支持,对Hex的识别,对-1,+1,对指针解引用,对寄存器的识别.
<code>+-*/</code>(二元运算),<code>+-</code>(单元运算),</p>
<h5 id="_16">对重复代码的再次抽象<a class="headerlink" href="#_16" title="Anchor link to this section for reference">&para;</a></h5>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="n">word_t</span><span class="w"> </span><span class="nf">eval</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="o">*</span><span class="n">sucess</span><span class="p">){</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">&gt;</span><span class="n">q</span><span class="p">){</span>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="w">    </span><span class="c1">// bad expression</span>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="w">    </span><span class="o">*</span><span class="n">sucess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">==</span><span class="n">q</span><span class="p">){</span>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a><span class="w">    </span><span class="cm">/* Single token.</span>
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a><span class="cm">     * For now this token should be a number.</span>
<a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a><span class="cm">     * Return the value of the number.</span>
<a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a><span class="cm">     */</span>
<a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">TK_NUM</span><span class="p">){</span>
<a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a><span class="w">      </span><span class="o">*</span><span class="n">sucess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">str</span><span class="p">);</span>
<a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">check_parentgeses</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">)</span><span class="o">==</span><span class="nb">true</span><span class="p">){</span>
<a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a><span class="w">    </span><span class="c1">// remove the outermost brackets</span>
<a id="__codelineno-51-20" name="__codelineno-51-20" href="#__codelineno-51-20"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">eval</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">q</span><span class="mi">-1</span><span class="p">,</span><span class="n">sucess</span><span class="p">);</span>
<a id="__codelineno-51-21" name="__codelineno-51-21" href="#__codelineno-51-21"></a><span class="w">  </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
<a id="__codelineno-51-22" name="__codelineno-51-22" href="#__codelineno-51-22"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="n">val1</span><span class="p">,</span><span class="n">val2</span><span class="p">;</span>
<a id="__codelineno-51-23" name="__codelineno-51-23" href="#__codelineno-51-23"></a><span class="w">    </span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prioty</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">);</span>
<a id="__codelineno-51-24" name="__codelineno-51-24" href="#__codelineno-51-24"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">op</span><span class="o">==</span><span class="mi">-1</span><span class="p">){</span>
<a id="__codelineno-51-25" name="__codelineno-51-25" href="#__codelineno-51-25"></a><span class="w">      </span><span class="o">*</span><span class="n">sucess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-51-26" name="__codelineno-51-26" href="#__codelineno-51-26"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-51-27" name="__codelineno-51-27" href="#__codelineno-51-27"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-51-28" name="__codelineno-51-28" href="#__codelineno-51-28"></a><span class="w">    </span><span class="c1">// val1 = eval(p,op-1,sucess);</span>
<a id="__codelineno-51-29" name="__codelineno-51-29" href="#__codelineno-51-29"></a><span class="w">    </span><span class="c1">// if(*sucess==false)return 0;</span>
<a id="__codelineno-51-30" name="__codelineno-51-30" href="#__codelineno-51-30"></a><span class="w">    </span><span class="c1">// val2 = eval(op+1,q,sucess);</span>
<a id="__codelineno-51-31" name="__codelineno-51-31" href="#__codelineno-51-31"></a><span class="w">    </span><span class="c1">// if(*sucess==false)return 0;</span>
<a id="__codelineno-51-32" name="__codelineno-51-32" href="#__codelineno-51-32"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">op</span><span class="p">].</span><span class="n">type</span><span class="p">)</span>
<a id="__codelineno-51-33" name="__codelineno-51-33" href="#__codelineno-51-33"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-51-34" name="__codelineno-51-34" href="#__codelineno-51-34"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;+&#39;</span><span class="p">:{</span>
<a id="__codelineno-51-35" name="__codelineno-51-35" href="#__codelineno-51-35"></a><span class="w">      </span><span class="n">val1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eval</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">op</span><span class="mi">-1</span><span class="p">,</span><span class="n">sucess</span><span class="p">);</span>
<a id="__codelineno-51-36" name="__codelineno-51-36" href="#__codelineno-51-36"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">sucess</span><span class="o">==</span><span class="nb">false</span><span class="p">)</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-51-37" name="__codelineno-51-37" href="#__codelineno-51-37"></a><span class="w">      </span><span class="n">val2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eval</span><span class="p">(</span><span class="n">op</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">sucess</span><span class="p">);</span>
<a id="__codelineno-51-38" name="__codelineno-51-38" href="#__codelineno-51-38"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">sucess</span><span class="o">==</span><span class="nb">false</span><span class="p">)</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-51-39" name="__codelineno-51-39" href="#__codelineno-51-39"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">val1</span><span class="o">+</span><span class="n">val2</span><span class="p">;</span>
<a id="__codelineno-51-40" name="__codelineno-51-40" href="#__codelineno-51-40"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-51-41" name="__codelineno-51-41" href="#__codelineno-51-41"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;-&#39;</span><span class="p">:{</span>
<a id="__codelineno-51-42" name="__codelineno-51-42" href="#__codelineno-51-42"></a><span class="w">      </span><span class="n">val1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eval</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">op</span><span class="mi">-1</span><span class="p">,</span><span class="n">sucess</span><span class="p">);</span>
<a id="__codelineno-51-43" name="__codelineno-51-43" href="#__codelineno-51-43"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">sucess</span><span class="o">==</span><span class="nb">false</span><span class="p">)</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-51-44" name="__codelineno-51-44" href="#__codelineno-51-44"></a><span class="w">      </span><span class="n">val2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eval</span><span class="p">(</span><span class="n">op</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">sucess</span><span class="p">);</span>
<a id="__codelineno-51-45" name="__codelineno-51-45" href="#__codelineno-51-45"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">sucess</span><span class="o">==</span><span class="nb">false</span><span class="p">)</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-51-46" name="__codelineno-51-46" href="#__codelineno-51-46"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">val1</span><span class="o">-</span><span class="n">val2</span><span class="p">;</span>
<a id="__codelineno-51-47" name="__codelineno-51-47" href="#__codelineno-51-47"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-51-48" name="__codelineno-51-48" href="#__codelineno-51-48"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;*&#39;</span><span class="p">:{</span>
<a id="__codelineno-51-49" name="__codelineno-51-49" href="#__codelineno-51-49"></a><span class="w">      </span><span class="n">val1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eval</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">op</span><span class="mi">-1</span><span class="p">,</span><span class="n">sucess</span><span class="p">);</span>
<a id="__codelineno-51-50" name="__codelineno-51-50" href="#__codelineno-51-50"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">sucess</span><span class="o">==</span><span class="nb">false</span><span class="p">)</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-51-51" name="__codelineno-51-51" href="#__codelineno-51-51"></a><span class="w">      </span><span class="n">val2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eval</span><span class="p">(</span><span class="n">op</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">sucess</span><span class="p">);</span>
<a id="__codelineno-51-52" name="__codelineno-51-52" href="#__codelineno-51-52"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">sucess</span><span class="o">==</span><span class="nb">false</span><span class="p">)</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-51-53" name="__codelineno-51-53" href="#__codelineno-51-53"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">val1</span><span class="o">*</span><span class="n">val2</span><span class="p">;}</span>
<a id="__codelineno-51-54" name="__codelineno-51-54" href="#__codelineno-51-54"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-51-55" name="__codelineno-51-55" href="#__codelineno-51-55"></a><span class="w">      </span><span class="n">val1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eval</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">op</span><span class="mi">-1</span><span class="p">,</span><span class="n">sucess</span><span class="p">);</span>
<a id="__codelineno-51-56" name="__codelineno-51-56" href="#__codelineno-51-56"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">sucess</span><span class="o">==</span><span class="nb">false</span><span class="p">)</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-51-57" name="__codelineno-51-57" href="#__codelineno-51-57"></a><span class="w">      </span><span class="n">val2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eval</span><span class="p">(</span><span class="n">op</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">sucess</span><span class="p">);</span>
<a id="__codelineno-51-58" name="__codelineno-51-58" href="#__codelineno-51-58"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">sucess</span><span class="o">==</span><span class="nb">false</span><span class="p">)</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-51-59" name="__codelineno-51-59" href="#__codelineno-51-59"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">val2</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
<a id="__codelineno-51-60" name="__codelineno-51-60" href="#__codelineno-51-60"></a><span class="w">        </span><span class="o">*</span><span class="n">sucess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-51-61" name="__codelineno-51-61" href="#__codelineno-51-61"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-51-62" name="__codelineno-51-62" href="#__codelineno-51-62"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-51-63" name="__codelineno-51-63" href="#__codelineno-51-63"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">val1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">val2</span><span class="p">;</span>
<a id="__codelineno-51-64" name="__codelineno-51-64" href="#__codelineno-51-64"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-51-65" name="__codelineno-51-65" href="#__codelineno-51-65"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">TK_NEG</span><span class="p">:{</span><span class="w"> </span>
<a id="__codelineno-51-66" name="__codelineno-51-66" href="#__codelineno-51-66"></a><span class="w">      </span><span class="c1">// printf(&quot;has been here&quot;);</span>
<a id="__codelineno-51-67" name="__codelineno-51-67" href="#__codelineno-51-67"></a><span class="w">      </span><span class="n">val2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eval</span><span class="p">(</span><span class="n">op</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">sucess</span><span class="p">);</span>
<a id="__codelineno-51-68" name="__codelineno-51-68" href="#__codelineno-51-68"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">val2</span><span class="p">;</span>
<a id="__codelineno-51-69" name="__codelineno-51-69" href="#__codelineno-51-69"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-51-70" name="__codelineno-51-70" href="#__codelineno-51-70"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-51-71" name="__codelineno-51-71" href="#__codelineno-51-71"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-51-72" name="__codelineno-51-72" href="#__codelineno-51-72"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-51-73" name="__codelineno-51-73" href="#__codelineno-51-73"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-51-74" name="__codelineno-51-74" href="#__codelineno-51-74"></a><span class="p">}</span>
</code></pre></div>
我采取的解决方法
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="w">    </span><span class="c1">// Makes it easier for the program </span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="w">    </span><span class="c1">//to run on machines with different word widths.</span>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MUXDEF</span><span class="p">(</span><span class="n">CONFIG_RV64</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MUXDEF</span><span class="p">(</span><span class="n">CONFIG_RV64</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="n">ANSI_FMT</span><span class="p">(</span><span class="s">&quot;%#0*x: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ANSI_FG_CYAN</span><span class="p">),</span><span class="n">width</span><span class="p">,</span><span class="n">expr</span><span class="p">);</span>
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="w">      </span><span class="n">word_t</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vaddr_read</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="w">      </span><span class="n">expr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%#0*x &quot;</span><span class="p">,</span><span class="n">width</span><span class="p">,</span><span class="n">w</span><span class="p">);</span>
<a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a><span class="w">    </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span><span class="w"> </span>
</code></pre></div>
一开始我不理解为什么要写一个双层循环
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="o">(</span>nemu<span class="o">)</span><span class="w"> </span>x<span class="w"> </span><span class="m">10</span><span class="w"> </span>0x80000000
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>0x80000000:<span class="w"> </span>0x00000297<span class="w"> </span>0x00028823<span class="w"> </span>0x0102c503<span class="w"> </span>0x00100073<span class="w"> </span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>0x80000010:<span class="w"> </span>0xdeadbeef<span class="w"> </span>0x65656565<span class="w"> </span>0x65656565<span class="w"> </span>0x65656565<span class="w"> </span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>0x80000020:<span class="w"> </span>0x65656565<span class="w"> </span>0x65656565<span class="w"> </span>
</code></pre></div>
要保证这样的输出,就需要一个双层循环,第一个循环是为了保证输出的行数,第二个循环是为了保证输出的列数,这样就可以保证输出的格式是正确的.</p>
<h5 id="risc324riscv648">关于risc32=&gt;4,riscv64=&gt;8<a class="headerlink" href="#risc324riscv648" title="Anchor link to this section for reference">&para;</a></h5>
<p>处理右结合的指针解引用(de+reference),需要注意的是
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="k">static</span><span class="w"> </span><span class="n">word_t</span><span class="w"> </span><span class="nf">calunary</span><span class="p">(</span><span class="n">word_t</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="kt">bool</span><span class="w"> </span><span class="o">*</span><span class="n">sucess</span><span class="p">){</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">TK_DEREF</span><span class="p">:</span>
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vaddr_read</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
<a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">TK_NEG</span><span class="p">:</span>
<a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">val</span><span class="p">;</span>
<a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a><span class="w">  </span><span class="k">default</span><span class="o">:</span>
<a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a><span class="w">    </span><span class="o">*</span><span class="n">sucess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a><span class="p">}</span>
</code></pre></div></p>
<h3 id="watch_point">watch_point<a class="headerlink" href="#watch_point" title="Anchor link to this section for reference">&para;</a></h3>
<p>请告诉我gdb中是如何使用监视点功能的
在 GDB 中,你可以使用以下步骤来使用监视点（watchpoint）功能：</p>
<ol>
<li><strong>设置监视点</strong>：使用 <code>watch</code> 命令来设置一个监视点.这个命令的格式是 <code>watch expr</code>,其中 <code>expr</code> 是你想要监视的表达式.当这个表达式的值发生改变时,程序的执行就会暂停.例如,如果你想要在变量 <code>x</code> 的值发生改变时暂停程序的执行,你可以使用以下命令：</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a>watch x
</code></pre></div>
<ol>
<li>
<p><strong>查看监视点</strong>：使用 <code>info watchpoints</code> 命令来查看当前设置的所有监视点.这个命令会显示一个列表,列出所有当前设置的监视点.对于每个监视点,它会显示监视点的编号,监视的表达式,以及表达式的当前值.</p>
</li>
<li>
<p><strong>删除监视点</strong>：使用 <code>delete</code> 命令来删除一个监视点.你需要在 <code>delete</code> 命令后面加上你想要删除的监视点的编号.例如,如果你想要删除编号为 1 的监视点,你可以使用以下命令：</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a>delete 1
</code></pre></div>
<p>你也可以使用 <code>delete</code> 命令而不带任何参数来删除所有的断点和监视点.</p>
<p>这就是在 GDB 中使用监视点功能的基本步骤.请注意,监视点是一种强大的工具,但是它们可能会显著地降低你的程序的运行速度,特别是当你监视的表达式涉及到复杂的计算或者大量的内存访问时.</p>
<h2 id="pa2">PA2<a class="headerlink" href="#pa2" title="Anchor link to this section for reference">&para;</a></h2>
<p>yemu模拟器
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="cp">#define NREG 4</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="cp">#define NMEM 16</span>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a>
<a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a><span class="c1">// 定义指令格式</span>
<a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="k">typedef</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">rs</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">rt</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">rtype</span><span class="p">;</span>
<a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">4</span><span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">mtype</span><span class="p">;</span>
<a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a><span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">inst</span><span class="p">;</span>
<a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a><span class="p">}</span><span class="w"> </span><span class="n">inst_t</span><span class="p">;</span>
<a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a><span class="c1">//</span>
<a id="__codelineno-57-14" name="__codelineno-57-14" href="#__codelineno-57-14"></a><span class="cp">#define DECODE_R(inst) uint8_t rt = (inst).rtype.rt, rs = (inst).rtype.rs</span>
<a id="__codelineno-57-15" name="__codelineno-57-15" href="#__codelineno-57-15"></a><span class="cp">#define DECODE_M(inst) uint8_t addr = (inst).mtype.addr</span>
<a id="__codelineno-57-16" name="__codelineno-57-16" href="#__codelineno-57-16"></a>
<a id="__codelineno-57-17" name="__codelineno-57-17" href="#__codelineno-57-17"></a><span class="kt">uint8_t</span><span class="w"> </span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">       </span><span class="c1">// PC, C语言中没有4位的数据类型, 我们采用8位类型来表示</span>
<a id="__codelineno-57-18" name="__codelineno-57-18" href="#__codelineno-57-18"></a><span class="kt">uint8_t</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="n">NREG</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span><span class="w"> </span><span class="c1">// 寄存器</span>
<a id="__codelineno-57-19" name="__codelineno-57-19" href="#__codelineno-57-19"></a><span class="kt">uint8_t</span><span class="w"> </span><span class="n">M</span><span class="p">[</span><span class="n">NMEM</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">   </span><span class="c1">// 内存, 其中包含一个计算z = x + y的程序</span>
<a id="__codelineno-57-20" name="__codelineno-57-20" href="#__codelineno-57-20"></a><span class="w">  </span><span class="mb">0b11100110</span><span class="p">,</span><span class="w">  </span><span class="c1">// load  6#     | R[0] &lt;- M[y]</span>
<a id="__codelineno-57-21" name="__codelineno-57-21" href="#__codelineno-57-21"></a><span class="w">  </span><span class="mb">0b00000100</span><span class="p">,</span><span class="w">  </span><span class="c1">// mov   r1, r0 | R[1] &lt;- R[0]</span>
<a id="__codelineno-57-22" name="__codelineno-57-22" href="#__codelineno-57-22"></a><span class="w">  </span><span class="mb">0b11100101</span><span class="p">,</span><span class="w">  </span><span class="c1">// load  5#     | R[0] &lt;- M[x]</span>
<a id="__codelineno-57-23" name="__codelineno-57-23" href="#__codelineno-57-23"></a><span class="w">  </span><span class="mb">0b00010001</span><span class="p">,</span><span class="w">  </span><span class="c1">// add   r0, r1 | R[0] &lt;- R[0] + R[1]</span>
<a id="__codelineno-57-24" name="__codelineno-57-24" href="#__codelineno-57-24"></a><span class="w">  </span><span class="mb">0b11110111</span><span class="p">,</span><span class="w">  </span><span class="c1">// store 7#     | M[z] &lt;- R[0]</span>
<a id="__codelineno-57-25" name="__codelineno-57-25" href="#__codelineno-57-25"></a><span class="w">  </span><span class="mb">0b00010000</span><span class="p">,</span><span class="w">  </span><span class="c1">// x = 16</span>
<a id="__codelineno-57-26" name="__codelineno-57-26" href="#__codelineno-57-26"></a><span class="w">  </span><span class="mb">0b00100001</span><span class="p">,</span><span class="w">  </span><span class="c1">// y = 33</span>
<a id="__codelineno-57-27" name="__codelineno-57-27" href="#__codelineno-57-27"></a><span class="w">  </span><span class="mb">0b00000000</span><span class="p">,</span><span class="w">  </span><span class="c1">// z = 0</span>
<a id="__codelineno-57-28" name="__codelineno-57-28" href="#__codelineno-57-28"></a><span class="p">};</span>
<a id="__codelineno-57-29" name="__codelineno-57-29" href="#__codelineno-57-29"></a>
<a id="__codelineno-57-30" name="__codelineno-57-30" href="#__codelineno-57-30"></a><span class="kt">int</span><span class="w"> </span><span class="n">halt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// 结束标志</span>
<a id="__codelineno-57-31" name="__codelineno-57-31" href="#__codelineno-57-31"></a>
<a id="__codelineno-57-32" name="__codelineno-57-32" href="#__codelineno-57-32"></a><span class="c1">// 执行一条指令</span>
<a id="__codelineno-57-33" name="__codelineno-57-33" href="#__codelineno-57-33"></a><span class="kt">void</span><span class="w"> </span><span class="nf">exec_once</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-57-34" name="__codelineno-57-34" href="#__codelineno-57-34"></a><span class="w">  </span><span class="n">inst_t</span><span class="w"> </span><span class="n">this</span><span class="p">;</span>
<a id="__codelineno-57-35" name="__codelineno-57-35" href="#__codelineno-57-35"></a><span class="w">  </span><span class="n">this</span><span class="p">.</span><span class="n">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">[</span><span class="n">pc</span><span class="p">];</span><span class="w"> </span><span class="c1">// 取指</span>
<a id="__codelineno-57-36" name="__codelineno-57-36" href="#__codelineno-57-36"></a><span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">rtype</span><span class="p">.</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-57-37" name="__codelineno-57-37" href="#__codelineno-57-37"></a><span class="w">  </span><span class="c1">//  操作码译码       操作数译码           执行</span>
<a id="__codelineno-57-38" name="__codelineno-57-38" href="#__codelineno-57-38"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mb">0b0000</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">DECODE_R</span><span class="p">(</span><span class="n">this</span><span class="p">);</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="n">rt</span><span class="p">]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="n">rs</span><span class="p">];</span><span class="w">   </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-57-39" name="__codelineno-57-39" href="#__codelineno-57-39"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mb">0b0001</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">DECODE_R</span><span class="p">(</span><span class="n">this</span><span class="p">);</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="n">rt</span><span class="p">]</span><span class="w">  </span><span class="o">+=</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="n">rs</span><span class="p">];</span><span class="w">   </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-57-40" name="__codelineno-57-40" href="#__codelineno-57-40"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mb">0b1110</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">DECODE_M</span><span class="p">(</span><span class="n">this</span><span class="p">);</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">[</span><span class="n">addr</span><span class="p">];</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-57-41" name="__codelineno-57-41" href="#__codelineno-57-41"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mb">0b1111</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">DECODE_M</span><span class="p">(</span><span class="n">this</span><span class="p">);</span><span class="w"> </span><span class="n">M</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-57-42" name="__codelineno-57-42" href="#__codelineno-57-42"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<a id="__codelineno-57-43" name="__codelineno-57-43" href="#__codelineno-57-43"></a><span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Invalid instruction with opcode = %x, halting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">rtype</span><span class="p">.</span><span class="n">op</span><span class="p">);</span>
<a id="__codelineno-57-44" name="__codelineno-57-44" href="#__codelineno-57-44"></a><span class="w">      </span><span class="n">halt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-57-45" name="__codelineno-57-45" href="#__codelineno-57-45"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-57-46" name="__codelineno-57-46" href="#__codelineno-57-46"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-57-47" name="__codelineno-57-47" href="#__codelineno-57-47"></a><span class="w">  </span><span class="n">pc</span><span class="w"> </span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="c1">// 更新PC</span>
<a id="__codelineno-57-48" name="__codelineno-57-48" href="#__codelineno-57-48"></a><span class="p">}</span>
<a id="__codelineno-57-49" name="__codelineno-57-49" href="#__codelineno-57-49"></a>
<a id="__codelineno-57-50" name="__codelineno-57-50" href="#__codelineno-57-50"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-57-51" name="__codelineno-57-51" href="#__codelineno-57-51"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-57-52" name="__codelineno-57-52" href="#__codelineno-57-52"></a><span class="w">    </span><span class="n">exec_once</span><span class="p">();</span>
<a id="__codelineno-57-53" name="__codelineno-57-53" href="#__codelineno-57-53"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">halt</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-57-54" name="__codelineno-57-54" href="#__codelineno-57-54"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-57-55" name="__codelineno-57-55" href="#__codelineno-57-55"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;The result of 16 + 33 is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
<a id="__codelineno-57-56" name="__codelineno-57-56" href="#__codelineno-57-56"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-57-57" name="__codelineno-57-57" href="#__codelineno-57-57"></a><span class="p">}</span>
</code></pre></div>
被PA2.1难哭了,看不明白这个巨量的宏(what can i say?),晚上回去把要交到邮箱的东西都填完.</p>
<h3 id="gcc">GCC提供的标签地址<a class="headerlink" href="#gcc" title="Anchor link to this section for reference">&para;</a></h3>
<p>使用了GCC提供的标签地址<a href="https://gcc.gnu.org/onlinedocs/gcc/Labels-as-Values.html">扩展功能</a></p>
<h3 id="gcc_1">告诉GCC总是尝试内联<a class="headerlink" href="#gcc_1" title="Anchor link to this section for reference">&para;</a></h3>
<p><code>__attribute__((always_inline))</code> 是GCC编译器的一个特性,用于告诉编译器总是尝试将某个函数内联.这是一个函数属性,通常在函数声明之前使用.</p>
<p>内联函数是一种优化技术,它通过将函数调用替换为函数体的内容来减少函数调用的开销.然而,内联函数并不总是提高程序的性能,因为它可能会增加程序的大小,并可能影响指令缓存的效率.因此,编译器通常会根据函数的大小和复杂性来决定是否将其内联.</p>
<p>然而,<code>__attribute__((always_inline))</code>属性告诉编译器无论函数的大小和复杂性如何,都应该尝试将其内联.这对于一些关键的、性能敏感的函数可能是有用的,但应该谨慎使用,以避免增加程序的大小和降低指令缓存的效率.</p>
<p>请注意,这个属性是GCC特有的,不是标准C++的一部分.如果你的代码需要在其他编译器上编译,你可能需要找到一个等效的属性或者使用其他方法来控制函数的内联行为. </p>
<h3 id="_17">查看复杂工程中某个特定文件的编译过程<a class="headerlink" href="#_17" title="Anchor link to this section for reference">&para;</a></h3>
<p>在C语言中,宏是一种预处理器指令,用于在编译时将代码片段替换为指定的文本.宏展开是指将宏调用替换为宏定义的文本的过程.</p>
<p>如果你想查看C文件中复杂宏的展开结果,可以使用GCC的预处理器选项<code>-E</code>.这个选项会让GCC在编译过程中只进行预处理,然后将预处理的结果输出到标准输出.</p>
<p>例如,如果你有一个名为<code>main.c</code>的文件,你可以使用以下命令来查看宏的展开结果：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a>gcc<span class="w"> </span>-E<span class="w"> </span>main.c
</code></pre></div>
<p>这个命令会将<code>main.c</code>文件中的所有宏都展开,并将结果输出到控制台.如果你想将结果保存到一个文件中,你可以使用重定向：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a>gcc<span class="w"> </span>-E<span class="w"> </span>main.c<span class="w"> </span>&gt;<span class="w"> </span>preprocessed.c
</code></pre></div>
<p>这个命令会将宏展开的结果保存到<code>preprocessed.c</code>文件中.</p>
<p>对于复杂的工程文件,你仍然可以使用GCC的预处理器选项<code>-E</code>来查看宏的展开结果.但是,你可能需要指定一些额外的编译选项,比如头文件的路径、预定义的宏等.</p>
<p>如果你使用的是make工具来构建你的项目,你可以修改Makefile,添加一个新的目标来生成预处理的文件.例如：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">preprocess</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="nf">preprocess</span><span class="o">:</span>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="w">    </span>gcc<span class="w"> </span>-E<span class="w"> </span><span class="k">$(</span>CFLAGS<span class="k">)</span><span class="w"> </span>main.c<span class="w"> </span>-o<span class="w"> </span>preprocessed.c
</code></pre></div>
<p>在这个例子中,<code>$(CFLAGS)</code>是一个变量,它包含了你的项目需要的所有编译选项.<code>main.c</code>是你想要预处理的文件,<code>preprocessed.c</code>是生成的预处理文件.</p>
<p>然后,你可以使用<code>make preprocess</code>命令来生成预处理文件.</p>
<p>如果你的项目使用的是其他构建工具（如CMake、Bazel等）,你可能需要查阅相应的文档来了解如何生成预处理文件. 根据你想要展开的文件的复杂性,你可能需要调整编译选项和预处理器选项.</p>
<h4 id="make-nb">make -nB<a class="headerlink" href="#make-nb" title="Anchor link to this section for reference">&para;</a></h4>
<p><code>make -n</code>或者<code>make --just-print</code>选项是用来显示make命令将要执行的操作,但是并不真正执行这些操作.这个选项通常用于查看make命令的执行过程,以便检查makefile文件是否正确配置.</p>
<p>通过<code>make -nB | vim -</code>来定位某个特定文件的编译过程.</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a>gcc<span class="w"> </span>-O2<span class="w"> </span>-MMD<span class="w"> </span>-Wall<span class="w"> </span>-Werror<span class="w"> </span>-I/home/along/ysyx-workbench/nemu/include<span class="w"> </span>-I/home/along/ysyx-workbench/nemu/src/isa/riscv32/include<span class="w"> </span>-I/home/along/ysyx-workbench/nemu/src/engine/interpreter<span class="w"> </span>-O2<span class="w">  </span>-Og<span class="w"> </span>-ggdb3<span class="w">  </span>-DITRACE_COND<span class="o">=</span><span class="nb">true</span><span class="w"> </span>-D__GUEST_ISA__<span class="o">=</span>riscv32<span class="w"> </span>-c<span class="w"> </span>-o<span class="w"> </span>/home/along/ysyx-workbench/nemu/build/obj-riscv32-nemu-interpreter/src/isa/riscv32/inst.o<span class="w"> </span>src/isa/riscv32/inst.c
</code></pre></div>
把<code>-o</code>=&gt;<code>-E</code>再把最后面加个<code>| vim -</code>经过简单的修改后可以很方便的看到宏展开的样子.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">__instpat_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="n">__instpat_end_</span><span class="p">;;</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">shift</span><span class="p">;</span><span class="w"> </span><span class="n">pattern_decode</span><span class="p">(</span><span class="s">&quot;0000000 00001 00000 000 00000 11100 11&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;0000000 00001 00000 000 00000 11100 11&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">shift</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((((</span><span class="kt">uint64_t</span><span class="p">)((</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">isa</span><span class="p">.</span><span class="n">inst</span><span class="p">.</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">shift</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">mask</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a><span class="w">        </span><span class="n">decode_operand</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">src1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">src2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">imm</span><span class="p">,</span><span class="w"> </span><span class="n">TYPE_R</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a><span class="w">        </span><span class="n">set_nemu_state</span><span class="p">(</span><span class="n">NEMU_END</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">cpu</span><span class="p">.</span><span class="n">gpr</span><span class="p">[</span><span class="n">check_reg_idx</span><span class="p">(</span><span class="mi">10</span><span class="p">)]))</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a><span class="w">      </span><span class="p">};</span><span class="w"> </span>
<a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">__instpat_end</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span>
<a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a><span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">shift</span><span class="p">;</span><span class="w"> </span><span class="n">pattern_decode</span><span class="p">(</span><span class="s">&quot;0000000 00001 00000 000 00000 11100 11&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;0000000 00001 00000 000 00000 11100 11&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">shift</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((((</span><span class="kt">uint64_t</span><span class="p">)((</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">isa</span><span class="p">.</span><span class="n">inst</span><span class="p">.</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">shift</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">mask</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-62-14" name="__codelineno-62-14" href="#__codelineno-62-14"></a><span class="w">        </span><span class="n">decode_operand</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">src1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">src2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">imm</span><span class="p">,</span><span class="w"> </span><span class="n">TYPE_N</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-62-15" name="__codelineno-62-15" href="#__codelineno-62-15"></a><span class="w">        </span><span class="n">set_nemu_state</span><span class="p">(</span><span class="n">NEMU_END</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">cpu</span><span class="p">.</span><span class="n">gpr</span><span class="p">[</span><span class="n">check_reg_idx</span><span class="p">(</span><span class="mi">10</span><span class="p">)]))</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-62-16" name="__codelineno-62-16" href="#__codelineno-62-16"></a><span class="w">      </span><span class="p">};</span><span class="w"> </span>
<a id="__codelineno-62-17" name="__codelineno-62-17" href="#__codelineno-62-17"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">__instpat_end</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-62-18" name="__codelineno-62-18" href="#__codelineno-62-18"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span>
<a id="__codelineno-62-19" name="__codelineno-62-19" href="#__codelineno-62-19"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-62-20" name="__codelineno-62-20" href="#__codelineno-62-20"></a>
<a id="__codelineno-62-21" name="__codelineno-62-21" href="#__codelineno-62-21"></a><span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">shift</span><span class="p">;</span><span class="w"> </span><span class="n">pattern_decode</span><span class="p">(</span><span class="s">&quot;??????? ????? ????? ??? ????? ????? ??&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;??????? ????? ????? ??? ????? ????? ??&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">shift</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-62-22" name="__codelineno-62-22" href="#__codelineno-62-22"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((((</span><span class="kt">uint64_t</span><span class="p">)((</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">isa</span><span class="p">.</span><span class="n">inst</span><span class="p">.</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">shift</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">mask</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-62-23" name="__codelineno-62-23" href="#__codelineno-62-23"></a><span class="w">      </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-62-24" name="__codelineno-62-24" href="#__codelineno-62-24"></a><span class="w">        </span><span class="n">decode_operand</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">src1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">src2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">imm</span><span class="p">,</span><span class="w"> </span><span class="n">TYPE_N</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-62-25" name="__codelineno-62-25" href="#__codelineno-62-25"></a><span class="w">        </span><span class="n">invalid_inst</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>
<a id="__codelineno-62-26" name="__codelineno-62-26" href="#__codelineno-62-26"></a><span class="w">      </span><span class="p">};</span><span class="w"> </span>
<a id="__codelineno-62-27" name="__codelineno-62-27" href="#__codelineno-62-27"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">__instpat_end</span><span class="p">);</span><span class="w"> </span>
<a id="__codelineno-62-28" name="__codelineno-62-28" href="#__codelineno-62-28"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span>
<a id="__codelineno-62-29" name="__codelineno-62-29" href="#__codelineno-62-29"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-62-30" name="__codelineno-62-30" href="#__codelineno-62-30"></a>
<a id="__codelineno-62-31" name="__codelineno-62-31" href="#__codelineno-62-31"></a><span class="w">  </span><span class="nl">__instpat_end_</span><span class="p">:</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-62-32" name="__codelineno-62-32" href="#__codelineno-62-32"></a>
<a id="__codelineno-62-33" name="__codelineno-62-33" href="#__codelineno-62-33"></a><span class="w">  </span><span class="p">(</span><span class="n">cpu</span><span class="p">.</span><span class="n">gpr</span><span class="p">[</span><span class="n">check_reg_idx</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-62-34" name="__codelineno-62-34" href="#__codelineno-62-34"></a>
<a id="__codelineno-62-35" name="__codelineno-62-35" href="#__codelineno-62-35"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-62-36" name="__codelineno-62-36" href="#__codelineno-62-36"></a><span class="p">}</span>
<a id="__codelineno-62-37" name="__codelineno-62-37" href="#__codelineno-62-37"></a>
<a id="__codelineno-62-38" name="__codelineno-62-38" href="#__codelineno-62-38"></a><span class="kt">int</span><span class="w"> </span><span class="n">isa_exec_once</span><span class="p">(</span><span class="n">Decode</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-62-39" name="__codelineno-62-39" href="#__codelineno-62-39"></a><span class="w">  </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">isa</span><span class="p">.</span><span class="n">inst</span><span class="p">.</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_fetch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">snpc</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<a id="__codelineno-62-40" name="__codelineno-62-40" href="#__codelineno-62-40"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">decode_exec</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<a id="__codelineno-62-41" name="__codelineno-62-41" href="#__codelineno-62-41"></a><span class="p">}</span>
</code></pre></div>
<h3 id="dummy">dummy<a class="headerlink" href="#dummy" title="Anchor link to this section for reference">&para;</a></h3>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a>➜<span class="w">   </span>make<span class="w"> </span><span class="nv">ARCH</span><span class="o">=</span><span class="nv">$ISA</span>-nemu<span class="w"> </span><span class="nv">ALL</span><span class="o">=</span>dummy<span class="w"> </span>run
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="c1"># Building dummy-run [-nemu]</span>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a>/home/along/ysyx-workbench/abstract-machine/Makefile:30:<span class="w"> </span>***<span class="w"> </span>Expected<span class="w"> </span><span class="nv">$ARCH</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">{</span>loongarch32r-nemu<span class="w"> </span>mips32-nemu<span class="w"> </span>native<span class="w"> </span>riscv32e-nemu<span class="w"> </span>riscv32e-npc<span class="w"> </span>riscv32-nemu<span class="w"> </span>riscv64-nemu<span class="w"> </span>spike<span class="w"> </span>x86_64-qemu<span class="w"> </span>x86-nemu<span class="w"> </span>x86-qemu<span class="o">}</span>,<span class="w"> </span>Got<span class="w"> </span><span class="s2">&quot;-nemu&quot;</span>.<span class="w">  </span>Stop.
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="w"> </span>dummy
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="o">[</span><span class="w">         </span>dummy<span class="o">]</span><span class="w"> </span>FAIL!
<a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a>
<a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a>➜<span class="w">   </span>make<span class="w"> </span><span class="nv">ARCH</span><span class="o">=</span>riscv32-nemu<span class="w"> </span><span class="nv">ALL</span><span class="o">=</span>dummy<span class="w"> </span>run<span class="w">  </span>
<a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a><span class="c1"># Building dummy-run [riscv32-nemu]</span>
<a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a>+<span class="w"> </span>CC<span class="w"> </span>tests/dummy.c
<a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a>cc1:<span class="w"> </span>error:<span class="w"> </span>‘-march<span class="o">=</span>rv32im_zicsr’:<span class="w"> </span>unsupported<span class="w"> </span>ISA<span class="w"> </span>subset<span class="w"> </span>‘z’
<a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a>make<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>***<span class="w"> </span><span class="o">[</span>/home/along/ysyx-workbench/abstract-machine/Makefile:110:<span class="w"> </span>/home/along/ysyx-workbench/am-kernels/tests/cpu-tests/build/riscv32-nemu/tests/dummy.o<span class="o">]</span><span class="w"> </span>Error<span class="w"> </span><span class="m">1</span>
<a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a><span class="w"> </span>dummy
<a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a><span class="o">[</span><span class="w">         </span>dummy<span class="o">]</span><span class="w"> </span>FAIL!
</code></pre></div>
报错原因是riscv的交叉编译器版本老了.</p>
<p>解决方法就是要么自行编译一个新的交叉编译器,要么直接下压缩包</p>
<p><code>/opt</code> 是 Linux 文件系统中的一个目录,通常用于存放可选的应用程序软件包.</p>
<p>在 Linux 系统中,<code>/opt</code> 目录通常用于存放第三方软件或额外的软件包,这些软件包可能不是由系统的包管理器管理的.例如,一些商业软件,如 Oracle 数据库,可能会选择在 <code>/opt</code> 目录下安装.</p>
<p>在 <code>/opt</code> 目录下安装软件可以使得系统的其他部分保持整洁,因为所有的文件都在 <code>/opt</code> 下的一个目录中,这使得卸载软件变得非常简单,只需要删除这个目录即可.</p>
<p>总的来说,<code>/opt</code> 是一个用于存放可选软件包的目录.</p>
<p>本来一直没有打算搜索报错的,最后还是搜索了报错.</p>
<h3 id="dummy_1">dummy运行<a class="headerlink" href="#dummy_1" title="Anchor link to this section for reference">&para;</a></h3>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="o">(</span>nemu<span class="o">)</span><span class="w"> </span>s
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>invalid<span class="w"> </span>opcode<span class="o">(</span><span class="nv">PC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x80000000<span class="o">)</span>:
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="w">    </span><span class="m">13</span><span class="w"> </span><span class="m">04</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">91</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span>...
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="w">    </span><span class="m">00000413</span><span class="w"> </span><span class="m">00009117</span>...
<a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a>There<span class="w"> </span>are<span class="w"> </span>two<span class="w"> </span>cases<span class="w"> </span>which<span class="w"> </span>will<span class="w"> </span>trigger<span class="w"> </span>this<span class="w"> </span>unexpected<span class="w"> </span>exception:
<a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a><span class="m">1</span>.<span class="w"> </span>The<span class="w"> </span>instruction<span class="w"> </span>at<span class="w"> </span><span class="nv">PC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x80000000<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>implemented.
<a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a><span class="m">2</span>.<span class="w"> </span>Something<span class="w"> </span>is<span class="w"> </span>implemented<span class="w"> </span>incorrectly.
<a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a>Find<span class="w"> </span>this<span class="w"> </span>PC<span class="o">(</span>0x80000000<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>disassembling<span class="w"> </span>result<span class="w"> </span>to<span class="w"> </span>distinguish<span class="w"> </span>which<span class="w"> </span><span class="k">case</span><span class="w"> </span>it<span class="w"> </span>is.
<a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a>
<a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a>If<span class="w"> </span>it<span class="w"> </span>is<span class="w"> </span>the<span class="w"> </span>first<span class="w"> </span><span class="k">case</span>,<span class="w"> </span>see
<a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a><span class="w">       </span>_<span class="w">                         </span>__<span class="w">  </span>__<span class="w">                         </span>_<span class="w"> </span>
<a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a><span class="w">      </span><span class="o">(</span>_<span class="o">)</span><span class="w">                       </span><span class="p">|</span><span class="w">  </span><span class="se">\/</span><span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span><span class="p">|</span>
<a id="__codelineno-64-13" name="__codelineno-64-13" href="#__codelineno-64-13"></a><span class="w">  </span>_<span class="w"> </span>__<span class="w"> </span>_<span class="w"> </span>___<span class="w">  </span>___<span class="w"> </span>________<span class="w">   </span>__<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\ </span><span class="w"> </span>/<span class="w"> </span><span class="p">|</span><span class="w"> </span>__<span class="w"> </span>_<span class="w"> </span>_<span class="w"> </span>__<span class="w">  </span>_<span class="w">   </span>_<span class="w">  </span>__<span class="w"> </span>_<span class="p">|</span><span class="w"> </span><span class="p">|</span>
<a id="__codelineno-64-14" name="__codelineno-64-14" href="#__codelineno-64-14"></a><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="s1">&#39;__| / __|/ __|______\ \ / / | |\/| |/ _` | &#39;</span>_<span class="w"> </span><span class="se">\|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span>/<span class="w"> </span>_<span class="sb">`</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span>
<a id="__codelineno-64-15" name="__codelineno-64-15" href="#__codelineno-64-15"></a><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="se">\_</span>_<span class="w"> </span><span class="se">\ </span><span class="o">(</span>__<span class="w">        </span><span class="se">\ </span>V<span class="w"> </span>/<span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="o">(</span>_<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span>_<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="o">(</span>_<span class="p">|</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">|</span>
<a id="__codelineno-64-16" name="__codelineno-64-16" href="#__codelineno-64-16"></a><span class="w"> </span><span class="p">|</span>_<span class="p">|</span><span class="w">  </span><span class="p">|</span>_<span class="p">|</span>___/<span class="se">\_</span>__<span class="p">|</span><span class="w">        </span><span class="se">\_</span>/<span class="w">   </span><span class="p">|</span>_<span class="p">|</span><span class="w">  </span><span class="p">|</span>_<span class="p">|</span><span class="se">\_</span>_,_<span class="p">|</span>_<span class="p">|</span><span class="w"> </span><span class="p">|</span>_<span class="p">|</span><span class="se">\_</span>_,_<span class="p">|</span><span class="se">\_</span>_,_<span class="p">|</span>_<span class="p">|</span>
<a id="__codelineno-64-17" name="__codelineno-64-17" href="#__codelineno-64-17"></a>
<a id="__codelineno-64-18" name="__codelineno-64-18" href="#__codelineno-64-18"></a><span class="k">for</span><span class="w"> </span>more<span class="w"> </span>details.
<a id="__codelineno-64-19" name="__codelineno-64-19" href="#__codelineno-64-19"></a>
<a id="__codelineno-64-20" name="__codelineno-64-20" href="#__codelineno-64-20"></a>If<span class="w"> </span>it<span class="w"> </span>is<span class="w"> </span>the<span class="w"> </span>second<span class="w"> </span><span class="k">case</span>,<span class="w"> </span>remember:
<a id="__codelineno-64-21" name="__codelineno-64-21" href="#__codelineno-64-21"></a>*<span class="w"> </span>The<span class="w"> </span>machine<span class="w"> </span>is<span class="w"> </span>always<span class="w"> </span>right!
<a id="__codelineno-64-22" name="__codelineno-64-22" href="#__codelineno-64-22"></a>*<span class="w"> </span>Every<span class="w"> </span>line<span class="w"> </span>of<span class="w"> </span>untested<span class="w"> </span>code<span class="w"> </span>is<span class="w"> </span>always<span class="w"> </span>wrong!
<a id="__codelineno-64-23" name="__codelineno-64-23" href="#__codelineno-64-23"></a>
<a id="__codelineno-64-24" name="__codelineno-64-24" href="#__codelineno-64-24"></a>0x80000000:<span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">04</span><span class="w"> </span><span class="m">13</span><span class="w"> </span>addi<span class="w">    </span>s0,<span class="w"> </span>zero,<span class="w"> </span><span class="m">0</span>
<a id="__codelineno-64-25" name="__codelineno-64-25" href="#__codelineno-64-25"></a><span class="o">[</span>src/cpu/cpu-exec.c:121<span class="w"> </span>cpu_exec<span class="o">]</span><span class="w"> </span>nemu:<span class="w"> </span>ABORT<span class="w"> </span>at<span class="w"> </span><span class="nv">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x80000000
<a id="__codelineno-64-26" name="__codelineno-64-26" href="#__codelineno-64-26"></a><span class="o">[</span>src/cpu/cpu-exec.c:89<span class="w"> </span>statistic<span class="o">]</span><span class="w"> </span>host<span class="w"> </span><span class="nb">time</span><span class="w"> </span><span class="nv">spent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">311</span><span class="w"> </span>us
<a id="__codelineno-64-27" name="__codelineno-64-27" href="#__codelineno-64-27"></a><span class="o">[</span>src/cpu/cpu-exec.c:90<span class="w"> </span>statistic<span class="o">]</span><span class="w"> </span>total<span class="w"> </span>guest<span class="w"> </span><span class="nv">instructions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-64-28" name="__codelineno-64-28" href="#__codelineno-64-28"></a><span class="o">[</span>src/cpu/cpu-exec.c:91<span class="w"> </span>statistic<span class="o">]</span><span class="w"> </span>simulation<span class="w"> </span><span class="nv">frequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>,215<span class="w"> </span>inst/s
</code></pre></div>
学习 RISC-V 的语义和指令格式是理解和使用这一现代指令集架构的关键.RISC-V 是一个开源、简洁、模块化的指令集架构,设计用于各种计算设备,从嵌入式系统到超级计算机都可以使用.以下是 RISC-V 的语义和指令格式的基本介绍：</p>
<h3 id="risc-v">RISC-V 指令集概述<a class="headerlink" href="#risc-v" title="Anchor link to this section for reference">&para;</a></h3>
<ol>
<li><strong>简介</strong>：</li>
<li>RISC-V（发音为 "risk-five"）是一个基于精简指令集（RISC）原则的开放指令集架构（ISA）.</li>
<li>
<p>设计简洁,包含了基本的指令集和标准的扩展,可以根据需求进行自定义扩展.</p>
</li>
<li>
<p><strong>指令格式</strong>：</p>
</li>
<li>
<p>RISC-V 指令有固定的长度（通常为 32 位）,可以分为不同的类型：R 类型（寄存器-寄存器操作）、I 类型（立即数操作）、S 类型（存储操作）、B 类型（分支操作）、U 类型（无条件跳转）、J 类型（条件跳转）等.</p>
</li>
<li>
<p><strong>寄存器</strong>：</p>
</li>
<li>
<p>RISC-V 使用整数寄存器（通常有 32 个,命名为 x0 到 x31）,以及一些特殊用途的寄存器（如程序计数器 PC、栈指针 SP 等）.</p>
</li>
<li>
<p><strong>指令语义</strong>：</p>
</li>
<li>每条指令都有明确定义的操作,涉及寄存器之间的数据传输、算术运算、逻辑运算、内存访问和控制流操作等.</li>
<li>指令的语义由操作码（opcode）和操作数（operands）组成,操作数可以是寄存器、立即数或内存地址.</li>
</ol>
<h3 id="_18">指令格式示例<a class="headerlink" href="#_18" title="Anchor link to this section for reference">&para;</a></h3>
<h4 id="r-">R 类型指令（寄存器-寄存器操作）<a class="headerlink" href="#r-" title="Anchor link to this section for reference">&para;</a></h4>
<p>R 类型指令用于寄存器之间的操作,如加法、减法等.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a>  31    25 24   20 19   15 14   12 11    7 6     0
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>+-------+-------+-------+-------+-------+-------+
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>| funct7|  rs2  |  rs1  | funct3|   rd  | opcode|
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a>+-------+-------+-------+-------+-------+-------+
</code></pre></div>
<ul>
<li><code>opcode</code>: 操作码,指定操作类型（如算术运算、逻辑运算等）.</li>
<li><code>rd</code>: 目标寄存器.</li>
<li><code>rs1</code>、<code>rs2</code>: 源寄存器.</li>
<li><code>funct3</code>、<code>funct7</code>: 针对操作的具体功能码.</li>
</ul>
<h4 id="i">I 类型指令（立即数操作）<a class="headerlink" href="#i" title="Anchor link to this section for reference">&para;</a></h4>
<p>I 类型指令用于将立即数与寄存器内容进行操作,如加载、存储、移位等.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>  31    20 19   15 14   12 11    7 6     0
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>+-------+-------+-------+-------+-------+-------+
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>| imm[11:0] |  rs1  | funct3|   rd  | opcode|
<a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a>+-------+-------+-------+-------+-------+-------+
</code></pre></div>
<ul>
<li><code>opcode</code>: 操作码.</li>
<li><code>rd</code>: 目标寄存器.</li>
<li><code>rs1</code>: 源寄存器.</li>
<li><code>imm[11:0]</code>: 12 位的立即数.</li>
</ul>
<h4 id="s">S 类型指令（存储操作）<a class="headerlink" href="#s" title="Anchor link to this section for reference">&para;</a></h4>
<p>S 类型指令用于存储数据到内存.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a>  31    25 24   20 19   15 14   12 11    7 6     0
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a>+-------+-------+-------+-------+-------+-------+
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a>| imm[11:5]|  rs2  |  rs1  | funct3| imm[4:0]| opcode|
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a>+-------+-------+-------+-------+-------+-------+
</code></pre></div>
<ul>
<li><code>opcode</code>: 操作码.</li>
<li><code>rs1</code>、<code>rs2</code>: 相关寄存器.</li>
<li><code>imm[11:0]</code>: 12 位的立即数,用于指定存储的偏移量.</li>
</ul>
<h3 id="_19">学习资源推荐<a class="headerlink" href="#_19" title="Anchor link to this section for reference">&para;</a></h3>
<p>如果你希望深入了解 RISC-V 的语义和指令格式,以下资源可能会对你有所帮助：</p>
<ul>
<li><a href="https://riscv.org/technical/specifications/">RISC-V 指令集手册</a></li>
<li><a href="https://riscv.org/education/">RISC-V 教育基金会的教育资源</a></li>
<li>RISC-V 相关的开放课程和在线学习平台（如 Coursera、edX 上的相关课程）</li>
</ul>
<p>通过这些资源,你可以系统地学习和理解 RISC-V 的指令集架构、指令格式以及操作语义,为进一步的学习和开发应用打下坚实的基础.</p>
<h3 id="ysyx-workbencham-kernelstestscpu-testsmakefile">ysyx-workbench/am-kernels/tests/cpu-tests/makefile<a class="headerlink" href="#ysyx-workbencham-kernelstestscpu-testsmakefile" title="Anchor link to this section for reference">&para;</a></h3>
<p><code>make ARCH=$ISA-nemu ALL=dummy</code></p>
<h4 id="result">&gt;.result<a class="headerlink" href="#result" title="Anchor link to this section for reference">&para;</a></h4>
<p>在 Makefile 中,<code>$(shell &gt; $(RESULT))</code> 这行代码使用了 GNU Make 的 <code>$(shell ...)</code> 函数.该函数允许在 Makefile 中执行任意的 shell 命令,并将其输出作为变量值.具体来说,这里执行的命令是 <code>&gt; .result</code>,它的作用是创建一个空的 <code>.result</code> 文件（如果文件已经存在,则清空它）.</p>
<h5 id="shell"><code>$(shell ...)</code> 函数<a class="headerlink" href="#shell" title="Anchor link to this section for reference">&para;</a></h5>
<p><code>$(shell ...)</code> 函数的语法如下：
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="k">$(</span><span class="nv">shell</span> <span class="nv">command</span><span class="k">)</span>
</code></pre></div></p>
<ul>
<li><code>command</code> 是要执行的 shell 命令.</li>
<li><code>$(shell ...)</code> 函数执行 <code>command</code> 并将其输出作为返回值.</li>
</ul>
<h5 id="_20">创建空文件<a class="headerlink" href="#_20" title="Anchor link to this section for reference">&para;</a></h5>
<p>在 shell 中,单独使用重定向操作符 <code>&gt;</code> 可以创建一个新文件或清空一个已存在的文件.例如：
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a>&gt;<span class="w"> </span>.result
</code></pre></div>
这条命令的效果是创建一个名为 <code>.result</code> 的空文件,如果 <code>.result</code> 文件已经存在,则会清空它的内容.</p>
<p>在 Makefile 中使用 <code>$(shell ...)</code> 执行这个命令的目的是确保在开始编译之前,结果文件 <code>.result</code> 是空的.这样可以避免将新编译的结果与之前的结果混在一起.</p>
<p>在 Makefile 中,<code>$(RESULT)</code> 是一个变量,用于存储编译和运行结果的文件名.在前面的 Makefile 示例中,它被定义为：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="nv">RESULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>.result
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="k">$(</span><span class="nv">shell</span> &gt; <span class="k">$(</span><span class="nv">RESULT</span><span class="k">))</span>
</code></pre></div>
<p><code>$(RESULT)</code> 变量的作用是记录每个测试文件的编译和运行结果.这种做法可以让你在编译多个测试文件后查看它们的结果,而不需要逐个查看编译输出.</p>
<h3 id="_21">详细说明<a class="headerlink" href="#_21" title="Anchor link to this section for reference">&para;</a></h3>
<ol>
<li><strong>变量定义</strong>：
   <div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="nv">RESULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>.result
</code></pre></div></li>
</ol>
<p>这行代码将 <code>RESULT</code> 变量定义为 <code>.result</code>,表示结果文件的名称是 <code>.result</code>.</p>
<ol>
<li><strong>初始化结果文件</strong>：
   <div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="k">$(</span><span class="nv">shell</span> &gt; <span class="k">$(</span><span class="nv">RESULT</span><span class="k">))</span>
</code></pre></div></li>
</ol>
<p>这行代码使用 <code>$(shell ...)</code> 函数执行 shell 命令 <code>&gt; .result</code>,这会创建一个空的 <code>.result</code> 文件（如果文件已经存在,则清空它）.这样可以确保每次运行 Makefile 时,结果文件都是空的,并且不会包含上次运行的结果.</p>
<ol>
<li>
<p><strong>记录编译结果</strong>：
   <div class="highlight"><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="err">@if</span><span class="w"> </span><span class="err">make</span><span class="w"> </span><span class="err">-s</span><span class="w"> </span><span class="err">-f</span><span class="w"> </span><span class="k">$@</span><span class="w"> </span><span class="nv">ARCH</span><span class="o">=</span><span class="k">$(</span>ARCH<span class="k">)</span><span class="w"> </span><span class="k">$(</span>MAKECMDGOALS<span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="w">    </span><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;[%14s] </span><span class="k">$(</span>COLOR_GREEN<span class="k">)</span><span class="s2">PASS!</span><span class="k">$(</span>COLOR_NONE<span class="k">)</span><span class="s2">\n&quot;</span><span class="w"> </span><span class="nv">$*</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="k">$(</span>RESULT<span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="cp">else \</span>
<a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="cp">    printf &quot;[%14s] $(COLOR_RED)FAIL!$(COLOR_NONE)\n&quot; $* &gt;&gt; $(RESULT); \</span>
<a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a><span class="cp">fi</span>
</code></pre></div></p>
</li>
<li>
<p><code>printf "[%14s] $(COLOR_GREEN)PASS!$(COLOR_NONE)\n" $* &gt;&gt; $(RESULT);</code>：如果编译成功,打印一行包含 "PASS!" 的信息,并追加到 <code>.result</code> 文件中.</p>
</li>
<li><code>printf "[%14s] $(COLOR_RED)FAIL!$(COLOR_NONE)\n" $* &gt;&gt; $(RESULT);</code>：如果编译失败,打印一行包含 "FAIL!" 的信息,并追加到 <code>.result</code> 文件中.</li>
</ol>
<p>这段代码是一个在 Makefile 文件中定义的命令,用于执行构建过程,并根据构建结果输出相应的信息到一个结果文件中.让我们逐步解析这段代码的功能和组成部分.</p>
<p>首先,这段代码使用了 <code>@</code> 前缀,这在 Makefile 中用来表示执行命令时,不将该命令本身输出到控制台.这样做可以让输出结果更加清晰,只显示我们关心的信息.(<span class="arithmatex">\(@表示targets,\)</span>^表示prerequisites,不如直接去看makefile manual)</p>
<p>接下来,使用 <code>if</code> 语句来判断 <code>make -s -f $@ ARCH=$(ARCH) $(MAKECMDGOALS)</code> 命令的执行结果.这里的 <code>-s</code> 选项表示在执行时不显示命令本身,<code>-f $@</code> 表示使用当前目标（<code>$@</code>）指定的 Makefile 文件.<code>ARCH=$(ARCH)</code> 是向 make 命令传递的一个变量,它的值取决于当前环境或者是在命令行中指定的值.<code>$(MAKECMDGOALS)</code> 是一个特殊的变量,包含了 make 命令行中指定的目标列表.</p>
<p>如果 <code>make</code> 命令执行成功（即返回值为 0）,则执行 <code>then</code> 分支,使用 <code>printf</code> 命令将格式化的成功信息追加到 <code>$(RESULT)</code> 指定的文件中.这里的 <code>[%14s]</code> 是 <code>printf</code> 格式字符串,用于将输出的字符串格式化为宽度为 14 个字符的字符串,如果不足则左侧填充空格.<code>$*</code> 代表了传递给当前规则的所有参数,<code>$(COLOR_GREEN)</code> 和 <code>$(COLOR_NONE)</code> 是在 Makefile 中定义的变量,用于设置文本颜色,以便在输出中高亮显示成功信息.</p>
<p>如果 <code>make</code> 命令执行失败（即返回值非 0）,则执行 <code>else</code> 分支,使用 <code>printf</code> 命令将格式化的失败信息追加到 <code>$(RESULT)</code> 指定的文件中.失败信息的格式与成功信息相同,不同之处在于使用了 <code>$(COLOR_RED)</code> 变量来设置文本颜色,以便在输出中高亮显示失败信息.</p>
<p>总的来说,这段代码通过执行另一个 Makefile 并检查其返回值,来决定是输出构建成功还是失败的信息,并将这些信息以特定的格式追加到一个结果文件中,同时通过颜色的变化使得结果一目了然.</p>
<ol>
<li>
<p><strong>显示结果</strong>：
   <div class="highlight"><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="nf">run</span><span class="o">:</span><span class="w"> </span><span class="n">all</span>
<a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="w">    </span>@cat<span class="w"> </span><span class="k">$(</span>RESULT<span class="k">)</span>
<a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a><span class="w">    </span>@rm<span class="w"> </span><span class="k">$(</span>RESULT<span class="k">)</span>
</code></pre></div></p>
</li>
<li>
<p><code>@cat $(RESULT)</code>：显示 <code>.result</code> 文件的内容,列出所有测试文件的编译和运行结果.</p>
</li>
<li><code>@rm $(RESULT)</code>：删除 <code>.result</code> 文件,清理临时文件.</li>
</ol>
<h4 id="_22">示例<a class="headerlink" href="#_22" title="Anchor link to this section for reference">&para;</a></h4>
<p>假设你有两个测试文件 <code>tests/dummy.c</code> 和 <code>tests/sample.c</code>,并且你运行 <code>make ARCH=$ISA-nemu ALL="dummy sample" run</code>.假设 <code>dummy.c</code> 编译成功而 <code>sample.c</code> 编译失败,<code>.result</code> 文件的内容可能如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a>        dummy PASS!
<a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a>       sample FAIL!
</code></pre></div>
<p>在 <code>run</code> 目标中,<code>cat .result</code> 将显示上述内容,<code>rm .result</code> 则会删除 <code>.result</code> 文件.</p>
<h4 id="_23">总结<a class="headerlink" href="#_23" title="Anchor link to this section for reference">&para;</a></h4>
<p><code>$(RESULT)</code> 是一个用于存储和显示编译和运行结果的临时文件名变量.它的定义和使用确保了每次运行 Makefile 时都能记录每个测试文件的结果,并在最终输出结果后清理该文件.</p>
<h3 id="pa21">PA2.1 指令实现<a class="headerlink" href="#pa21" title="Anchor link to this section for reference">&para;</a></h3>
<h4 id="_24">教训<a class="headerlink" href="#_24" title="Anchor link to this section for reference">&para;</a></h4>
<p>YSYX的这个开放架构设计之道有一点没写好(例如结构太混乱了,介绍基本指令格式的时候,U型指令的立即数20位左移都没说,就开始介绍减少扇形面积之类的知识看得很一头雾水,怪不得很多blog说不如直接去看官方手册,这点确实,唉)</p>
<p>指令实现就是纯抄手册,补全框架代码里的空白,这个没什么好说的,就是要多看手册,多看手册,多看手册.(例如取立即数的几个imm,)难绷拿copilot生成的取立即数宏居然是错的,当时偷懒了没去看手册,结果浪费了很多时间测试出这个问题.</p>
<h4 id="gdb">gdb条件调试<a class="headerlink" href="#gdb" title="Anchor link to this section for reference">&para;</a></h4>
<p>mersenne测试未通过,需要使用gdb进行调试.
先break到大概地方再使用,condition来完成条件调试.
(笨办法自然是s N手动找出来那个step会abortion的地方)</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span><span class="k">break</span><span class="w"> </span>exec_once
<a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>condition<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">(</span>s-&gt;dnpc<span class="w"> </span><span class="o">==</span><span class="w"> </span>0x7ffffcdc<span class="o">)</span>
</code></pre></div>
<h4 id="make-nb-vim-">make -nB | vim -<a class="headerlink" href="#make-nb-vim-" title="Anchor link to this section for reference">&para;</a></h4>
<p><code>sed</code> <code>grep</code> ()
<div class="highlight"><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a># 只保留gcc或g++开头的行
<a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a>:%!grep &quot;^\(gcc\|g++\)&quot;
<a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>
<a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a># 将环境变量$NEMU_HOME所指示字符串替换为$NEMU_HOME
<a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a>:%!sed -e &quot;s+$NEMU_HOME+\$NEMU_HOME+g&quot;
<a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a>
<a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a># 将$NEMU_HOME/build/obj-riscv32-nemu-interpreter替换为$OBJ_DIR
<a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a>:%s+\$NEMU_HOME/build/obj-riscv32-nemu-interpreter+$OBJ_DIR+g
<a id="__codelineno-77-9" name="__codelineno-77-9" href="#__codelineno-77-9"></a>
<a id="__codelineno-77-10" name="__codelineno-77-10" href="#__codelineno-77-10"></a># 将-c之前的内容替换为$CFLAGS
<a id="__codelineno-77-11" name="__codelineno-77-11" href="#__codelineno-77-11"></a>:%s/-O2.*=riscv32/$CFLAGS/g
<a id="__codelineno-77-12" name="__codelineno-77-12" href="#__codelineno-77-12"></a>
<a id="__codelineno-77-13" name="__codelineno-77-13" href="#__codelineno-77-13"></a># 将最后一行的空格替换成换行并缩进两格
<a id="__codelineno-77-14" name="__codelineno-77-14" href="#__codelineno-77-14"></a>:$s/  */\r  /g
</code></pre></div></p>
<p>以下是你列出的几条 Vim 编辑命令的解释及使用场景：</p>
<ol>
<li>
<p><strong>只保留 <code>gcc</code> 或 <code>g++</code> 开头的行</strong>：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="p">:</span>%<span class="p">!</span><span class="k">grep</span> <span class="s2">&quot;^\(gcc\|g++\)&quot;</span>
</code></pre></div>
    这个命令使用 <code>grep</code> 工具筛选出当前文件中所有以 <code>gcc</code> 或 <code>g++</code> 开头的行.<code>%</code> 表示整个文件,<code>!</code> 表示执行外部命令,<code>grep "^\(gcc\|g++\)"</code> 用于匹配行首为 <code>gcc</code> 或 <code>g++</code> 的行.</p>
</li>
<li>
<p><strong>将环境变量 <code>$NEMU_HOME</code> 所指示字符串替换为 <code>$NEMU_HOME</code></strong>：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="p">:</span>%<span class="p">!</span>sed <span class="p">-</span><span class="k">e</span> <span class="s2">&quot;s+$NEMU_HOME+\$NEMU_HOME+g&quot;</span>
</code></pre></div>
    这个命令使用 <code>sed</code> 工具将文件中所有 <code>$NEMU_HOME</code> 的值替换为字符串 <code>\$NEMU_HOME</code>.<code>s+old+new+g</code> 是 <code>sed</code> 的替换命令,其中 <code>+</code> 是分隔符,可以根据需要选择合适的分隔符.</p>
</li>
<li>
<p><strong>将 <code>$NEMU_HOME/build/obj-riscv32-nemu-interpreter</code> 替换为 <code>$OBJ_DIR</code></strong>：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="p">:</span>%s<span class="p">+</span>\$NEMU_HOME<span class="sr">/build/</span>obj<span class="p">-</span>riscv32<span class="p">-</span>nemu<span class="p">-</span>interpreter<span class="p">+</span>$OBJ_DIR<span class="p">+</span><span class="k">g</span>
</code></pre></div>
    这个命令使用 Vim 的替换命令将文件中所有 <code>$NEMU_HOME/build/obj-riscv32-nemu-interpreter</code> 替换为 <code>$OBJ_DIR</code>.<code>%</code> 表示整个文件,<code>s</code> 是替换命令.</p>
</li>
<li>
<p><strong>将 <code>-c</code> 之前的内容替换为 <code>$CFLAGS</code></strong>：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="p">:</span>%s<span class="sr">/-O2.*=riscv32/</span>$CFLAGS/<span class="k">g</span>
</code></pre></div>
    这个命令使用 Vim 的替换命令,将文件中 <code>-O2</code> 到 <code>=riscv32</code> 之间的内容替换为 <code>$CFLAGS</code>.<code>%</code> 表示整个文件,<code>s</code> 是替换命令.</p>
</li>
<li>
<p><strong>将最后一行的空格替换成换行并缩进两格</strong>：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="p">:</span>$s<span class="sr">/  */</span>\<span class="k">r</span>  /<span class="k">g</span>
</code></pre></div>
    这个命令使用 Vim 的替换命令,将最后一行中的每个空格段替换为换行符并在新行开始处缩进两格.<code>$</code> 表示最后一行,<code>s</code> 是替换命令,<code>\r</code> 表示换行符,<code></code> 表示两个空格.</p>
</li>
<li>
<p><strong>筛出来.c结尾的行</strong>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="p">:</span>%<span class="p">!</span><span class="k">grep</span> <span class="s2">&quot;\.c$&quot;</span>
</code></pre></div>
    这个命令使用 <code>grep</code> 工具筛选出当前文件中所有以 <code>.c</code> 结尾的行.<code>%</code> 表示整个文件,<code>!</code> 表示执行外部命令,<code>grep "\.c$"</code> 用于匹配行尾为 <code>.c</code> 的行.</p>
</li>
</ol>
<p><code>sed</code> 和 <code>grep</code> 是两个在 Unix/Linux 环境中广泛使用的文本处理工具.它们有不同的用途和功能,下面是对它们的详细介绍：</p>
<h5 id="grepglobal-regular-expression-print"><code>grep</code>（Global Regular Expression Print）<a class="headerlink" href="#grepglobal-regular-expression-print" title="Anchor link to this section for reference">&para;</a></h5>
<p><code>grep</code> 是一个用于搜索文本的工具,它通过匹配正则表达式来查找文本中的特定模式.<code>grep</code> 可以用于在文件中搜索特定的字符串或模式,并输出匹配的行.</p>
<p><strong>基本用法</strong>：
<div class="highlight"><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a>grep<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span><span class="w"> </span>PATTERN<span class="w"> </span><span class="o">[</span>FILE...<span class="o">]</span>
</code></pre></div></p>
<p><strong>常用选项</strong>：
- <code>-i</code>：忽略大小写.
- <code>-v</code>：反转匹配,显示不匹配的行.
- <code>-r</code>：递归搜索目录.
- <code>-l</code>：仅显示包含匹配行的文件名.
- <code>-n</code>：显示匹配行的行号.
- <code>-E</code>: 使用扩展正则表达式.
<strong>示例</strong>：
<div class="highlight"><pre><span></span><code><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="c1"># 在文件example.txt中搜索包含字符串&#39;pattern&#39;的行</span>
<a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a>grep<span class="w"> </span><span class="s1">&#39;pattern&#39;</span><span class="w"> </span>example.txt
<a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a>
<a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a><span class="c1"># 在当前目录及其子目录中递归搜索包含字符串&#39;pattern&#39;的文件</span>
<a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a>grep<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;pattern&#39;</span><span class="w"> </span>.
</code></pre></div></p>
<h5 id="sedstream-editor"><code>sed</code>（Stream Editor）<a class="headerlink" href="#sedstream-editor" title="Anchor link to this section for reference">&para;</a></h5>
<p><code>sed</code> 是一个流编辑器,用于对文本进行过滤和转换.<code>sed</code> 可以对文本进行插入、删除、替换和其他操作,通常用于处理文件中的文本数据.</p>
<p><strong>基本用法</strong>：
<div class="highlight"><pre><span></span><code><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a>sed<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span><span class="w"> </span><span class="s1">&#39;script&#39;</span><span class="w"> </span><span class="o">[</span>FILE...<span class="o">]</span>
</code></pre></div></p>
<p><strong>常用选项</strong>：
- <code>-e script</code>：添加要执行的脚本.
- <code>-f script-file</code>：从脚本文件中读取命令.
- <code>-n</code>：抑制自动打印,只有在脚本中使用<code>p</code>命令时才打印行.
- <code>-i</code>：直接编辑文件,而不是输出到标准输出.</p>
<p><strong>常用命令</strong>：
- <code>s/pattern/replacement/</code>：替换匹配的模式.
- <code>d</code>：删除行.
- <code>p</code>：打印行.
- <code>a\text</code>：在当前行之后插入文本.
- <code>i\text</code>：在当前行之前插入文本.</p>
<p><strong>示例</strong>：
<div class="highlight"><pre><span></span><code><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="c1"># 将文件example.txt中的所有&#39;old&#39;替换为&#39;new&#39;</span>
<a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a>sed<span class="w"> </span><span class="s1">&#39;s/old/new/g&#39;</span><span class="w"> </span>example.txt
<a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a>
<a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a><span class="c1"># 删除文件example.txt中的第2行</span>
<a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a>sed<span class="w"> </span><span class="s1">&#39;2d&#39;</span><span class="w"> </span>example.txt
<a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a>
<a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a><span class="c1"># 在文件example.txt的第3行后插入&#39;this is a new line&#39;</span>
<a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a>sed<span class="w"> </span><span class="s1">&#39;3a\this is a new line&#39;</span><span class="w"> </span>example.txt
</code></pre></div></p>
<h3 id="grep-sed"><code>grep</code> 和 <code>sed</code> 的联合使用<a class="headerlink" href="#grep-sed" title="Anchor link to this section for reference">&para;</a></h3>
<p><code>grep</code> 和 <code>sed</code> 可以结合使用,以实现更强大的文本处理功能.例如,先使用 <code>grep</code> 筛选出特定的行,然后用 <code>sed</code> 对这些行进行进一步的处理.</p>
<p><strong>示例</strong>：
<div class="highlight"><pre><span></span><code><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="c1"># 先用grep找出包含&#39;pattern&#39;的行,再用sed将&#39;old&#39;替换为&#39;new&#39;</span>
<a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a>grep<span class="w"> </span><span class="s1">&#39;pattern&#39;</span><span class="w"> </span>example.txt<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/old/new/g&#39;</span>
</code></pre></div></p>
<p>通过 <code>grep</code> 和 <code>sed</code> 的组合,能够高效地进行复杂的文本处理任务.</p>
<h4 id="tabnew">:tabnew命令<a class="headerlink" href="#tabnew" title="Anchor link to this section for reference">&para;</a></h4>
<p><code>:tabnew</code> 命令用于在 Vim 编辑器中打开一个新的标签页.在 Vim 中,标签页是一种方便的多文件管理方式,可以在同一个 Vim 实例中同时编辑多个文件.</p>
<p><code>:tabnew</code> 是 Vim 编辑器中的一个命令,用于在新标签页中打开文件.标签页允许用户在多个文件之间切换,同时保持每个文件的打开状态,从而提高多任务处理的效率.</p>
<h5 id="_25">基本用法<a class="headerlink" href="#_25" title="Anchor link to this section for reference">&para;</a></h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="p">:</span><span class="k">tabnew</span> [filename]
</code></pre></div>
<ul>
<li><code>:tabnew</code>：打开一个空的标签页.</li>
<li><code>:tabnew filename</code>：在一个新标签页中打开指定的文件.</li>
</ul>
<h5 id="_26">示例<a class="headerlink" href="#_26" title="Anchor link to this section for reference">&para;</a></h5>
<ol>
<li>
<p><strong>打开一个空标签页</strong>：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a><span class="p">:</span><span class="k">tabnew</span>
</code></pre></div></p>
</li>
<li>
<p><strong>在新标签页中打开文件</strong>：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a><span class="p">:</span><span class="k">tabnew</span> myfile.txt
</code></pre></div></p>
</li>
</ol>
<h5 id="_27">标签页操作<a class="headerlink" href="#_27" title="Anchor link to this section for reference">&para;</a></h5>
<p>以下是一些常用的标签页操作命令：</p>
<ul>
<li><code>:tabnext</code> 或 <code>:tabn</code>：切换到下一个标签页.</li>
<li><code>:tabprevious</code> 或 <code>:tabp</code>：切换到上一个标签页.</li>
<li><code>:tabfirst</code>：切换到第一个标签页.</li>
<li><code>:tablast</code>：切换到最后一个标签页.</li>
<li><code>:tabclose</code> 或 <code>:tabc</code>：关闭当前标签页.</li>
<li><code>:tabs</code>：列出所有打开的标签页.</li>
</ul>
<h5 id="_28">快捷键操作<a class="headerlink" href="#_28" title="Anchor link to this section for reference">&para;</a></h5>
<p>Vim 还提供了快捷键来方便地操作标签页：</p>
<ul>
<li><code>gt</code>：切换到下一个标签页.</li>
<li><code>gT</code>：切换到上一个标签页.</li>
<li><code>{N}gt</code>：切换到第 N 个标签页（例如,<code>3gt</code> 切换到第三个标签页）.</li>
</ul>
<p>使用标签页功能,可以在 Vim 中更加高效地管理和编辑多个文件.</p>
<h4 id="_29">#功能<a class="headerlink" href="#_29" title="Anchor link to this section for reference">&para;</a></h4>
<p><code>#</code> 是 Vim 编辑器中的一个快捷键,用于在当前文件中查找光标所在位置的单词,并跳转到下一个匹配的位置.这个功能通常用于快速定位和查找文本中的关键字.</p>
<p><code>xargs</code> 是一个非常有用的 Unix 命令,用于将输入转换为命令行参数.它允许你将标准输入的数据传递给其他命令,特别适用于处理长列表的文件或其他项目.下面是对 <code>xargs</code> 的详细介绍：</p>
<h4 id="xargs">xargs基本语法<a class="headerlink" href="#xargs" title="Anchor link to this section for reference">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a>xargs<span class="w"> </span><span class="o">[</span>options<span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="nb">command</span><span class="w"> </span><span class="o">[</span>initial-arguments<span class="o">]]</span>
</code></pre></div>
<h4 id="_30">主要功能<a class="headerlink" href="#_30" title="Anchor link to this section for reference">&para;</a></h4>
<p><code>xargs</code> 读取标准输入并将其分割成一组参数,然后将这些参数传递给指定的命令.</p>
<h4 id="_31">主要选项<a class="headerlink" href="#_31" title="Anchor link to this section for reference">&para;</a></h4>
<ul>
<li><code>-0</code>：输入项目以空字符（null character）分隔,常用于与 <code>find -print0</code> 搭配使用.</li>
<li><code>-d delimiter</code>：自定义定界符,分割输入项目.</li>
<li><code>-I replace-str</code>：定义替换字符串,指定每次替换输入中的每个参数.</li>
<li><code>-n number</code>：指定每次传递给命令的参数数目.</li>
<li><code>-P max-procs</code>：指定同时运行的最大进程数（并行执行）.</li>
<li><code>-L max-lines</code>：指定每次读取的输入行数.</li>
</ul>
<h4 id="_32">使用示例<a class="headerlink" href="#_32" title="Anchor link to this section for reference">&para;</a></h4>
<ol>
<li>
<p><strong>简单示例</strong>：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;file1.txt file2.txt file3.txt&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>rm
</code></pre></div>
    这个命令会删除 <code>file1.txt</code>、<code>file2.txt</code> 和 <code>file3.txt</code>.</p>
</li>
<li>
<p><strong>结合 <code>find</code> 使用</strong>：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a>find<span class="w"> </span>.<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*.log&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>rm
</code></pre></div>
    这个命令会找到当前目录及其子目录下的所有 <code>.log</code> 文件并删除它们.</p>
</li>
<li>
<p><strong>处理带空格的文件名</strong>：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a>find<span class="w"> </span>.<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*.log&quot;</span><span class="w"> </span>-print0<span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>-0<span class="w"> </span>rm
</code></pre></div>
    <code>-print0</code> 选项使 <code>find</code> 输出以 null 字符分隔的文件名,<code>xargs -0</code> 能正确处理这些文件名,即使它们包含空格或换行符.</p>
</li>
<li>
<p><strong>限制每次命令行的参数数量</strong>：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a>find<span class="w"> </span>.<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*.txt&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>-n<span class="w"> </span><span class="m">5</span><span class="w"> </span>cp<span class="w"> </span>-t<span class="w"> </span>/backup
</code></pre></div>
    这个命令每次会传递 5 个文件给 <code>cp</code> 命令,将它们复制到 <code>/backup</code> 目录.</p>
</li>
<li>
<p><strong>并行执行</strong>：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a>find<span class="w"> </span>.<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*.log&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>-P<span class="w"> </span><span class="m">4</span><span class="w"> </span>gzip
</code></pre></div>
    这个命令会使用最多 4 个并行进程来压缩找到的 <code>.log</code> 文件.</p>
</li>
<li>
<p><strong>使用替换字符串</strong>：
    <div class="highlight"><pre><span></span><code><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;file1 file2 file3&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>-I<span class="w"> </span><span class="o">{}</span><span class="w"> </span>mv<span class="w"> </span><span class="o">{}</span><span class="w"> </span>/new/location
</code></pre></div>
    这个命令会将 <code>file1</code>、<code>file2</code> 和 <code>file3</code> 移动到 <code>/new/location</code> 目录,<code>{}</code> 会被每个文件名替换.</p>
</li>
</ol>
<h4 id="_33">总结<a class="headerlink" href="#_33" title="Anchor link to this section for reference">&para;</a></h4>
<p><code>xargs</code> 是一个强大的工具,能显著提高处理批量文件或参数的效率.通过将标准输入转换为命令行参数,它在许多脚本和自动化任务中扮演着重要角色.</p>
<h3 id="_34">取除<a class="headerlink" href="#_34" title="Anchor link to this section for reference">&para;</a></h3>
<p>在正则表达式中,符号 <code>^</code> 有两个主要作用,具体取决于它所在的位置：</p>
<h4 id="1">1. 行首匹配符<a class="headerlink" href="#1" title="Anchor link to this section for reference">&para;</a></h4>
<p>当 <code>^</code> 位于正则表达式的开头时,它表示匹配行的开头.也就是说,<code>^pattern</code> 只会匹配那些以 <code>pattern</code> 开头的行.</p>
<p>示例</p>
<ul>
<li>
<p><strong>匹配以 "hello" 开头的行</strong>：
  <div class="highlight"><pre><span></span><code><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a>grep<span class="w"> </span><span class="s2">&quot;^hello&quot;</span><span class="w"> </span>file.txt
</code></pre></div>
  例如,文件 <code>file.txt</code> 中有以下内容：
  <div class="highlight"><pre><span></span><code><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a>hello world
<a id="__codelineno-100-2" name="__codelineno-100-2" href="#__codelineno-100-2"></a>say hello
<a id="__codelineno-100-3" name="__codelineno-100-3" href="#__codelineno-100-3"></a>hello there
</code></pre></div>
  只有第一行和第三行会被匹配.</p>
</li>
<li>
<p><strong>匹配以数字开头的行</strong>：
  <div class="highlight"><pre><span></span><code><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a>grep<span class="w"> </span><span class="s2">&quot;^[0-9]&quot;</span><span class="w"> </span>file.txt
</code></pre></div>
  例如,文件 <code>file.txt</code> 中有以下内容：
  <div class="highlight"><pre><span></span><code><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a>1. This is a test.
<a id="__codelineno-102-2" name="__codelineno-102-2" href="#__codelineno-102-2"></a>This is another test.
<a id="__codelineno-102-3" name="__codelineno-102-3" href="#__codelineno-102-3"></a>42 is the answer.
</code></pre></div>
  只有第一行和第三行会被匹配.</p>
</li>
</ul>
<h4 id="2">2. 否定字符集<a class="headerlink" href="#2" title="Anchor link to this section for reference">&para;</a></h4>
<p>当 <code>^</code> 位于方括号 <code>[]</code> 中的开头时,它表示否定字符集.也就是说,<code>[^abc]</code> 表示匹配任何不在 <code>abc</code> 之内的字符.</p>
<ul>
<li>
<p><strong>匹配不包含元音字母的字符</strong>：
  <div class="highlight"><pre><span></span><code><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a>grep<span class="w"> </span><span class="s2">&quot;[^aeiou]&quot;</span><span class="w"> </span>file.txt
</code></pre></div>
  例如,文件 <code>file.txt</code> 中有以下内容：
  <div class="highlight"><pre><span></span><code><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a>apple
<a id="__codelineno-104-2" name="__codelineno-104-2" href="#__codelineno-104-2"></a>banana
<a id="__codelineno-104-3" name="__codelineno-104-3" href="#__codelineno-104-3"></a>cherry
</code></pre></div>
  每一行都会匹配,因为每行都有至少一个非元音字母.</p>
</li>
<li>
<p><strong>匹配不包含数字的字符</strong>：
  <div class="highlight"><pre><span></span><code><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a>grep<span class="w"> </span><span class="s2">&quot;[^0-9]&quot;</span><span class="w"> </span>file.txt
</code></pre></div>
  例如,文件 <code>file.txt</code> 中有以下内容：
  <div class="highlight"><pre><span></span><code><a id="__codelineno-106-1" name="__codelineno-106-1" href="#__codelineno-106-1"></a>1234
<a id="__codelineno-106-2" name="__codelineno-106-2" href="#__codelineno-106-2"></a>abcd
<a id="__codelineno-106-3" name="__codelineno-106-3" href="#__codelineno-106-3"></a>a1b2c3
</code></pre></div>
  第二行和第三行会被匹配,因为它们包含非数字字符.</p>
</li>
<li>
<p><code>^pattern</code>：匹配行的开头.</p>
</li>
<li><code>[^chars]</code>：匹配不在 <code>chars</code> 内的任意字符.</li>
</ul>
<p>这些规则使得 <code>^</code> 在正则表达式中非常有用,可以用于匹配行的特定位置或排除特定字符集.</p>
<h4 id="nemugrep">nemu中的grep<a class="headerlink" href="#nemugrep" title="Anchor link to this section for reference">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-107-1" name="__codelineno-107-1" href="#__codelineno-107-1"></a>find<span class="w"> </span>.<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*.[ch]&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s2">&quot;^\./(src|include)&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-107-2" name="__codelineno-107-2" href="#__codelineno-107-2"></a><span class="w">  </span>grep<span class="w"> </span>-E<span class="w"> </span>-v<span class="w"> </span><span class="s2">&quot;^\./include/config&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s2">&quot;mips32\|riscv64\|loongarch32r&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>wc
<a id="__codelineno-107-3" name="__codelineno-107-3" href="#__codelineno-107-3"></a>find<span class="w"> </span>.<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*.[ch]&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s2">&quot;^\./(src|include)&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-107-4" name="__codelineno-107-4" href="#__codelineno-107-4"></a><span class="w">  </span>grep<span class="w"> </span>-E<span class="w"> </span>-v<span class="w"> </span><span class="s2">&quot;^\./include/config&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s2">&quot;mips32\|riscv64\|loongarch32r&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>wc
<a id="__codelineno-107-5" name="__codelineno-107-5" href="#__codelineno-107-5"></a>
<a id="__codelineno-107-6" name="__codelineno-107-6" href="#__codelineno-107-6"></a>//<span class="w"> </span>wc<span class="w"> </span><span class="o">(</span>print<span class="w"> </span>newline,word,and<span class="w"> </span>the<span class="w"> </span>byte<span class="w"> </span>counts<span class="w"> </span><span class="k">for</span><span class="w"> </span>each<span class="w"> </span>file<span class="o">)</span>
</code></pre></div>
<h3 id="sext">SEXT宏的作用<a class="headerlink" href="#sext" title="Anchor link to this section for reference">&para;</a></h3>
<p><code>SEXT</code> 宏的作用是将一个有符号数的低位扩展为更高位,以保持其符号位不变.在计算机系统中,有符号数通常使用补码表示,即最高位为符号位,0 表示正数,1 表示负数.当需要将一个低位有符号数扩展为更高位时,需要保持符号位不变,即将符号位复制到更高位.(copilot说的)</p>
<p>其实这些值存在内存里都是32位,只是在显示的时候显示成若干位,所以需要进行符号扩展.</p>
<h3 id="pa22">PA2.2<a class="headerlink" href="#pa22" title="Anchor link to this section for reference">&para;</a></h3>
<h3 id="_35">链接和加载<a class="headerlink" href="#_35" title="Anchor link to this section for reference">&para;</a></h3>
<p>GCC 提供了许多选项来控制编译过程,每个选项都有特定的功能,许多选项的缩写也直观地反映了它们的功能.以下是一些常见的 GCC 选项及其功能与缩写的关系：</p>
<ol>
<li><strong><code>-o</code> (output)</strong>：</li>
<li>功能：指定输出文件的名称.</li>
<li>缩写来源：<code>o</code> 代表“output”.</li>
<li>
<p>示例：<code>gcc -o my_program foo.c</code> 将编译 <code>foo.c</code> 并将输出的可执行文件命名为 <code>my_program</code>.</p>
</li>
<li>
<p><strong><code>-I</code> (include)</strong>：</p>
</li>
<li>功能：指定额外的头文件搜索路径.</li>
<li>缩写来源：<code>I</code> 代表“include”.</li>
<li>
<p>示例：<code>gcc -I/my/include/path foo.c</code> 将在 <code>/my/include/path</code> 中搜索头文件.</p>
</li>
<li>
<p><strong><code>-L</code> (library path)</strong>：</p>
</li>
<li>功能：指定额外的库文件搜索路径.</li>
<li>缩写来源：<code>L</code> 代表“library path”.</li>
<li>
<p>示例：<code>gcc -L/my/library/path foo.c</code> 将在 <code>/my/library/path</code> 中搜索库文件.</p>
</li>
<li>
<p><strong><code>-l</code> (library)</strong>：</p>
</li>
<li>功能：指定链接时要使用的库.</li>
<li>缩写来源：<code>l</code> 代表“library”.</li>
<li>
<p>示例：<code>gcc -o my_program foo.o -lm</code> 将链接数学库（libm）.</p>
</li>
<li>
<p><strong><code>-g</code> (debug)</strong>：</p>
</li>
<li>功能：生成调试信息,用于调试器（如 GDB）.</li>
<li>缩写来源：<code>g</code> 代表“debug”.</li>
<li>
<p>示例：<code>gcc -g foo.c</code> 将编译 <code>foo.c</code> 并生成调试信息.</p>
</li>
<li>
<p><strong><code>-O</code> (optimize)</strong>：</p>
</li>
<li>功能：指定优化级别（如 <code>-O2</code>）.</li>
<li>缩写来源：<code>O</code> 代表“optimize”.</li>
<li>
<p>示例：<code>gcc -O2 foo.c</code> 将以优化级别 2 编译 <code>foo.c</code>.</p>
</li>
<li>
<p><strong><code>-D</code> (define)</strong>：</p>
</li>
<li>功能：定义预处理宏.</li>
<li>缩写来源：<code>D</code> 代表“define”.</li>
<li>
<p>示例：<code>gcc -DDEBUG foo.c</code> 将在编译 <code>foo.c</code> 时定义 <code>DEBUG</code> 宏.</p>
</li>
<li>
<p><strong><code>-E</code> (preprocess)</strong>：</p>
</li>
<li>功能：只执行预处理步骤,不进行编译.</li>
<li>缩写来源：<code>E</code> 代表“preprocess”.</li>
<li>
<p>示例：<code>gcc -E foo.c</code> 将预处理 <code>foo.c</code> 并输出结果.</p>
</li>
<li>
<p><strong><code>-S</code> (assembly)</strong>：</p>
</li>
<li>功能：生成汇编代码,而不进行汇编和链接.</li>
<li>缩写来源：<code>S</code> 代表“assembly”.</li>
<li>
<p>示例：<code>gcc -S foo.c</code> 将编译 <code>foo.c</code> 并生成汇编代码文件 <code>foo.s</code>.</p>
</li>
<li>
<p><strong><code>-Wall</code> (all warnings)</strong>：</p>
<ul>
<li>功能：启用所有常见的警告.</li>
<li>缩写来源：<code>Wall</code> 代表“all warnings”.</li>
<li>示例：<code>gcc -Wall foo.c</code> 将编译 <code>foo.c</code> 并启用所有常见的警告.</li>
</ul>
</li>
<li>
<p>** <code>-c</code> (compile)**:</p>
<ul>
<li>功能：编译源文件,但不进行链接.</li>
<li>缩写来源：<code>c</code> 代表“compile”.</li>
<li>示例：<code>gcc -c foo.c</code> 将编译 <code>foo.c</code> 生成目标文件 <code>foo.o</code>.</li>
</ul>
</li>
</ol>
<p>这些选项提供了对编译过程的细粒度控制,帮助开发者优化和调试他们的程序.</p>
<ol>
<li><strong><code>-ggdb</code> (GDB debug)</strong>：<ul>
<li>功能：生成供 GDB 使用的详细调试信息.</li>
<li>缩写来源：<code>ggdb</code> 代表“GDB debug”.</li>
<li>示例：<code>gcc -ggdb foo.c</code> 将编译 <code>foo.c</code> 并生成详细的调试信息.</li>
</ul>
</li>
</ol>
<p>主要选项解释
- <strong>-g</strong>: 生成基本的调试信息。
- <strong>-ggdb</strong>: 生成供 GDB 使用的调试信息，并且比 <code>-g</code> 更详细。包含更多的调试信息，比如 GNU 扩展。</p>
<p>假设你有一个源文件 <code>example.c</code>，你可以使用以下命令编译它：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-108-1" name="__codelineno-108-1" href="#__codelineno-108-1"></a>gcc<span class="w"> </span>-ggdb<span class="w"> </span>-o<span class="w"> </span>example<span class="w"> </span>example.c
</code></pre></div>
<p>这会生成一个名为 <code>example</code> 的可执行文件，并包含 GDB 所需的详细调试信息。</p>
<p>优点
- <strong>更详细的调试信息</strong>: 提供了更丰富的调试信息，便于使用 GDB 进行复杂的调试。
- <strong>适用于 GDB</strong>: 特别适合与 GDB 搭配使用，可以更好地利用 GDB 的高级调试功能。</p>
<p>缺点
- <strong>较大的二进制文件</strong>: 由于包含了更多的调试信息，生成的可执行文件会比只使用 <code>-g</code> 更大。
- <strong>可能会影响性能</strong>: 虽然调试信息不会影响运行时性能，但在某些情况下，包含调试信息的文件可能会导致编译和链接时间增加。</p>
<p>调试示例
编译后，可以使用 GDB 调试生成的可执行文件：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-109-1" name="__codelineno-109-1" href="#__codelineno-109-1"></a>gdb<span class="w"> </span>example
</code></pre></div>
<p>在 GDB 中，你可以设置断点、检查变量、单步执行代码等，这些调试操作都会受益于详细的调试信息。</p>
<p>使用 <code>-ggdb</code> 可以大大提高调试的便利性和效率，尤其是在处理复杂的代码或调试难以复现的错误时。</p>
<h3 id="coreutils-binutilsgnu">coreutils 和 binutils(GNU工具链)<a class="headerlink" href="#coreutils-binutilsgnu" title="Anchor link to this section for reference">&para;</a></h3>
<p><code>coreutils</code> 和 <code>binutils</code> 是 GNU 工具集中的两个重要组件,分别提供了核心工具和二进制工具的功能.以下是对这两个工具集的简要介绍：</p>
<h4 id="coreutils">coreutils<a class="headerlink" href="#coreutils" title="Anchor link to this section for reference">&para;</a></h4>

                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; 2023<a href="https://github.com/dragonzhoulong" target="_blank" rel="noopener"> dragon</a>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/dragonzhoulong" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tabs", "navigation.sections", "navigation.path", "toc.integrate", "toc.follow", "navigation.top", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotate", "content.code.copy"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
        <script src="https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js"></script>
      
        <script src="../../js/tablesort.js"></script>
      
        <script src="https://cdn.tonycrane.cc/utils/katex.min.js"></script>
      
        <script src="../../js/katex.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>